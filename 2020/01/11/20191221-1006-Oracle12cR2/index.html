<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/shin.png">
  <link rel="icon" type="image/png" href="/img/shin.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="Shinnosuke Guo">
  <meta name="keywords" content="">
  <title>20200104_0956-Oracle12cR2（持续更新） ~ Shinnosuke</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Shinnosuke</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/archive.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Saturday, January 11th 2020, 11:42 am
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    8.9k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      42 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h2 id="OCP12c"><a href="#OCP12c" class="headerlink" title="OCP12c"></a>OCP12c</h2><h3 id="01-Oracle12cR2"><a href="#01-Oracle12cR2" class="headerlink" title="01. Oracle12cR2"></a>01. Oracle12cR2</h3><ul>
<li>Repo Point<br><a href="https://www.oracle.com/downloads/software-license-agreement.html#license-lightbox" target="_blank" rel="noopener">&lt;Oracle-12.2&gt;linuxx64_12201_database.zip</a><img src="640.gif" srcset="/img/loading.gif" width="300" >


</li>
</ul>
<h3 id="02-runInstaller"><a href="#02-runInstaller" class="headerlink" title="02. ./runInstaller"></a>02. ./runInstaller</h3><p><code>To be continued...</code></p>
<ul>
<li>先单独点出一个本地图形化的调用，困扰了好久，按下列指令完成后，会在本地弹出图形化界面，前提是本地的ssh软件需要开启<code>Xserver服务</code>!!!</li>
</ul>
<pre><code class="bash">[root@ocp12c ~]# xhost +
access control disabled, clients can connect from any HOST   ⬅ 允许客户端访问主机IP的Xserver
[root@ocp12c ~]# su - oracle
Last login: Sat Jan 18 00:32:43 CST 2020 on pts/3
[oracle@ocp12c ~]$ export DISPLAY=192.168.17.1:0.0
[oracle@ocp12c ~]$ cd /soft/database
[oracle@ocp12c ~]$ ./runInstaller
Starting Oracle Universal Installer...

Checking Temp space: must be greater than 500 MB.   Actual 146736 MB    Passed
Checking swap space: must be greater than 150 MB.   Actual 7079 MB    Passed
Checking monitor: must be configured to display at least 256 colors.    Actual 16777216    Passed
Preparing to launch Oracle Universal Installer from /tmp/OraInstall2020-01-18_12-37-03AM. Please wait ...</code></pre>
<h3 id="03-Oracle12c-架构"><a href="#03-Oracle12c-架构" class="headerlink" title="03. Oracle12c 架构"></a>03. Oracle12c 架构</h3><h4 id="实例和内存结构"><a href="#实例和内存结构" class="headerlink" title="实例和内存结构"></a>实例和内存结构</h4><p><code>Instance</code> 实例其实就是物理内存段的一部分，相当于软件进程.<br><code>kernel.shmall</code> 为共享内存大小，按照192.168.62.103测试库来看，可以配置为 <strong>4294967296</strong> 个page（4KB/page）.<br><code>kernel.shmmax</code> 用于定义单个共享内存段的最大值，<code>kernel.shmmax</code> 设置应该足够大，能在一个共享内存段下容纳下整个的 <code>SGA</code> ，设置的过低可能会导致需要创建多个共享内存段，这样可能导致系统性能的下降，最大值为16GB（在大多数情况下，该值应该比SGA大）.按照192.168.62.103测试库（内存128G）来看，可以配置为 <strong>88719476736</strong>（82GB）.<br>53477376 pages / 219043332096 bytes</p>
<p><code>Ex</code> 内核参数，系统内存4G，下面为对应内核配置大小（出自官方白皮书）<br><img src="Linux内核参数.png" srcset="/img/loading.gif" title="Linux内核参数" alt="Linux内核参数"></p>
<p>实例内存由下面<strong>两组内存参数</strong>动态调整：<br><code>SGA</code>（total_mem × 80%） × 80%，一般不超过物理内存的1/2.<br><code>PGA</code>（total_mem × 80%） × 20%.</p>
<table>
<thead>
<tr>
<th align="center">SGA参数</th>
<th align="center">×</th>
<th align="center">MEM参数</th>
</tr>
</thead>
<tbody><tr>
<td align="center">×</td>
<td align="center">×</td>
<td align="center"><code>MEMORY_MAX_TARGET</code>（静态）⬇</td>
</tr>
<tr>
<td align="center">x</td>
<td align="center"><code>SGA_MAX_SIZE</code></td>
<td align="center"><code>MEMORY_TARGET</code>（动态）⬇</td>
</tr>
<tr>
<td align="center">×</td>
<td align="center"><code>SGA_TARGET</code>⬇</td>
<td align="center"><code>PGA_AGGREGATE_TARGET</code>（PGA_AGGREGATE_LIMIT）⬇</td>
</tr>
<tr>
<td align="center">×</td>
<td align="center"><code>DB_CACHE</code> <code>SHARED_POOL</code> <code>LARGE_POOL</code> …</td>
<td align="center"></td>
</tr>
</tbody></table>
<img src="RAM.png" srcset="/img/loading.gif" title="内存架构" alt="内存架构">

<hr>
<h4 id="关于SGA和PGA的一点配置总结"><a href="#关于SGA和PGA的一点配置总结" class="headerlink" title="关于SGA和PGA的一点配置总结"></a>关于SGA和PGA的一点配置总结</h4><p><code>Tips</code> 相关总结不一定正确，仍需实验验证.<br>[相关博客：关于oracle11G的自动内存管理MEMORY_TARGET和MEMORY_MAX_TARGET]（<a href="https://blog.csdn.net/fjseryi/article/details/50818843）" target="_blank" rel="noopener">https://blog.csdn.net/fjseryi/article/details/50818843）</a><br><code>MEMORY_MAX_TARGET</code> 参数定义了 <code>MEMORY_TARGET</code> 可以达到的最大值，若未设置，则默认等于 <code>MEMORY_TARGET</code> 的值；该值为数据库初始化参数，不可动态调节，通过调整Spfile中的<code>MEMORY_MAX_TARGET</code>并重启实例，可以达到调整的目的.<br><code>MEMORY_TARGET</code> SGA + PGA. Oracle总共可以使用的共享内存大小，不可超过 <code>MEMORY_MAX_TARGET</code> 的大小，默认为0；该值可以动态调节，无需重启实例.<br><code>动态内存管理</code> 使用动态内存管理时，<code>MEMORY_TARGET</code>下的 <code>SGA_TARGET</code> 和 <code>PGA_AGGREGATE_TARGET</code> 代表它们各自内存区域的<strong>最小设置</strong>，要让Oracle完全控制内存管理，上述两个参数应该设置为0.</p>
<ul>
<li><p><code>MEMORY_TARGET</code>设置为非0值：<br>  → 设置了<code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code>，则两个参数将各自作为最小值，作为各自的初始化目标值.<br>  → 未设置<code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code>，则根据DB状态按照一个固定比例分配：<br>  SGA = MEMORY_TARGET * 60%.<br>  PGA_AGGREGATE_TARGET = MEMORY_TARGET * 40%.<br>  → 仅设置了两个中的一个，则 SGA = MEMORY_TARGET - PGA_AGGREGATE_TARGET；反之类似.</p>
</li>
<li><p><code>MEMORY_TARGET</code>设置为0或未设置：<br>  → 设置了<code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code>，则自动调节 <code>SGA</code> 中的 Shared pool、Buffer Cache、Redo Log Buffer、Java Pool、Larger Pool等内存空间的大小；PGA 则依赖 <code>PGA_AGGREGATE_TARGET</code> 的大小。 <code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code> 不能自动增长和自动缩小.<br>  → 未设置<code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code>，第1点<code>SGA</code> 中的各二级内存配置需要被明确设定，<code>SGA</code>/<code>PGA_AGGREGATE_TARGET</code> 不能自动增长和自动缩小.<br>  → <code>MEMORY_MAX_TARGET</code> 设置而 <code>MEMORY_TARGET</code> = 0，这种情况不太懂？？？</p>
</li>
</ul>
<hr>
<h4 id="SGA下的各种缓冲区（二级内存配置）"><a href="#SGA下的各种缓冲区（二级内存配置）" class="headerlink" title="SGA下的各种缓冲区（二级内存配置）"></a>SGA下的各种缓冲区（二级内存配置）</h4><ul>
<li><code>Data Buffer Cache</code> 数据高速缓冲区，又分级为：Dirty Buffer/Free Buffer/Pinned Buffer<br>  → <code>Dirty Buffer</code> 脏缓冲区，当数据库发生 DML（Insert、Update、Delete）操作时，会对缓冲区内容进行修改，这样缓冲区的内容就会和相对应的数据文件不一致，这时，缓冲区标识为“脏缓冲区”.<br>  → <code>Free Buffer</code> 自由缓冲区，当“脏缓冲区”的内容被写入数据文件后，因为该缓冲区与相应数据文件部分内容一致，所以将这些缓冲区称为“自由缓冲区”；当执行 SELECT 语句时，会将对应数据文件部分数据读取到数据高速缓存的相应缓冲区，因为缓冲区与数据块内容完全一致，所以这些缓冲区也被称为“自由缓冲区”.<br>  → <code>Pinned Buffer</code> 忙缓冲区，指服务器进程正在访问的缓冲区.<br>  → 为了防止数据库高速缓冲区空间不够用，Oracle 会将脏缓冲区中的数据写入对应的数据文件中（<code>Redo.log</code>），以腾出空间给新的数据.</li>
</ul>
<p><code>Ex</code> 高速缓冲区的大小管理</p>
<pre><code class="bash"># 显示高速缓冲区的大小
# &quot;0&quot; 表示数据库自动管理，这里表示设置的是最小值。
show parameter db_cache_size

# 修改数据库高速缓冲区大小
alter system set db_cache_size=500m; 

# flush缓冲区，生产库慎用
alter system flush buffer_cache</code></pre>
<hr>
<ul>
<li><code>Redo Log Buffer</code> 重做日志缓冲区（循环文件，redo01.log/redo02.log/redo03.log），由一条条重做项构成，大小初始化参数为LOG_BUFFER.</li>
</ul>
<hr>
<ul>
<li><code>Shared Pool</code> SGA的共享池，内含库缓存、数字字典缓冲区（执行计划的依赖来源）等.<br>  <code>数据字典缓冲区</code> 数据库参考信息（数据库结构/用户等）<br>  <code>库高速缓存</code> 共享SQL区和共享PL/SQL区.</li>
</ul>
<p><code>Ex</code> Shared Pool 展示</p>
<pre><code class="SQL">--当用户执行语句时
SELECT * FROM emp WHERE empno=7788;
--Oracle 需要查询数据字典 dba_tables 确定表 emp 是否存在
--如果该表已经存在，还需要查询数据字典 dba_tab_columns 确定列 empno 在表 emp 中是否存在
SELECT * FROM dba_tab_columns WHERE column_name = &#39;EMPNO&#39;;

--然后才能生成执行语句的过程（执行计划），这些定义在首次查询时存入数据字典高速缓冲区.</code></pre>
<hr>
<ul>
<li><code>大型池 Java池 流池</code><br>主要是大型池的大小影响数据备份效率.</li>
</ul>
<hr>
<h4 id="PGA（了解即可）"><a href="#PGA（了解即可）" class="headerlink" title="PGA（了解即可）"></a>PGA（了解即可）</h4><p><code>PGA</code> 私有SQL、会话内存、SQL工作区.<br><code>PGA_AGGREGATE_LIMIT</code> PGA_AGGREGATE_TARGET 以外的一个PGA参数，用于进行PGA使用率的硬性限制，当超过当前PGA时，Oracle会自动终止会话以保持合适的PGA内存.</p>
<pre><code class="SQL">ALTER SYSTEM SET PGA_AGGREGATE_LIMIT=2G;
ALTER SYSTEM SET PGA_AGGREGATE_LIMIT=0; --disables the hard limit</code></pre>
<h4 id="In-Memory-Column-Store"><a href="#In-Memory-Column-Store" class="headerlink" title="In-Memory Column Store"></a>In-Memory Column Store</h4><ul>
<li><code>In-Memory area</code> 适用于：<br>  → 资源表中的行非常多，但查询结果行不多.<br>  → 资源表中的列很多，但查询结果的列很少.<br>  → 查询聚集数据</li>
</ul>
<h4 id="数据更新时相关进程的走势"><a href="#数据更新时相关进程的走势" class="headerlink" title="数据更新时相关进程的走势"></a>数据更新时相关进程的走势</h4><ul>
<li><p>用户进程：用户机器上的进程，在服务端体现为进程状态中的LOCAL和非LOCAL.</p>
<img src="用户进程.png" srcset="/img/loading.gif" title="用户进程" alt="用户进程">
</li>
<li><p>服务进程：<code>LOCAL</code>进程，连接用户进程和实例</p>
</li>
<li><p>后台进程：<code>LGWR</code> <code>DBWn</code> <code>CKPT</code>/ <code>SMON</code> <code>PMON</code> 实例的一部分</p>
</li>
<li><p>实例：<code>SGA</code> <code>PGA</code> 等</p>
</li>
</ul>
<hr>
<ul>
<li><p>Origin ➡ Buffer_cache</p>
<img src="进程1.png" srcset="/img/loading.gif" title="Origin ➡ Buffer_cache" alt="Buffer_cache">
</li>
<li><p>New ➡ Redo_buffer     Redo_buffer ➡ Buffer_cache</p>
<img src="进程2.png" srcset="/img/loading.gif" title="New ➡ Redo_buffer" alt="Redo_buffer">
</li>
<li><p>Redo_buffer ➡ redo01~03.log       Buffer_cache ➡ Origin &amp;&amp; Update SCN &amp;&amp; 数据库同步</p>
<img src="进程3.png" srcset="/img/loading.gif" title="Redo_buffer ➡ Buffer_cache" alt="Buffer_cache">


</li>
</ul>
<pre><code class="bash"># redo01~03.log
[oracle@ocp12c prod1]$ ll /u01/app/oracle/oradata/prod1     # $ORACLE_BASE/oradata/prod1
total 3607664
-rw-r----- 1 oracle oinstall   10600448 Dec 28 12:53 control01.ctl
-rw-r----- 1 oracle oinstall  209715712 Dec 28 12:52 redo01.log
-rw-r----- 1 oracle oinstall  209715712 Dec 28 11:46 redo02.log
-rw-r----- 1 oracle oinstall  209715712 Dec 28 11:47 redo03.log
-rw-r----- 1 oracle oinstall  817897472 Dec 28 12:51 sysaux01.dbf
-rw-r----- 1 oracle oinstall  933240832 Dec 28 12:50 system01.dbf
-rw-r----- 1 oracle oinstall   67117056 Dec 28 09:36 temp01.dbf
-rw-r----- 1 oracle oinstall 1289756672 Dec 28 12:50 undotbs01.dbf
-rw-r----- 1 oracle oinstall    5251072 Dec 28 11:51 users01.dbf</code></pre>
<hr>
<h4 id="redo01-redo03-log-VS-undo-data"><a href="#redo01-redo03-log-VS-undo-data" class="headerlink" title="redo01~redo03.log VS undo.data"></a>redo01~redo03.log VS undo.data</h4><p><code>Tips</code> <code>redo.log/undo.data</code>之间的一点关联和解析，需结合上述后台进程进行理解<br><img src="redo_log&undo_data.png" srcset="/img/loading.gif" title="数据更新流程" alt="数据更新流程"></p>
<hr>
<h3 id="04-实例管理"><a href="#04-实例管理" class="headerlink" title="04. 实例管理"></a>04. 实例管理</h3><h4 id="实例加载"><a href="#实例加载" class="headerlink" title="实例加载"></a>实例加载</h4><ul>
<li><p><code>NOMOUNT</code> 进程启动<br>  $ORACLE_HOME/dbs/ 下的 spfile<SID>.ora/init<SID>.ora<br>  打开alter_<SID>.log/trace文件<br>  分配SGA，启动进程</p>
</li>
<li><p><code>MOUNT</code> 挂载状态<br>  定位所有控制文件<br>  通过加载控制文件，定位实例数据文件/Redo日志在哪里，但不介入（不判断是否真的存在），加载后台实例/动态性能视图，</p>
</li>
<li><p><code>OPEN</code> 介入数据文件，打开数据库数据文件/Redo日志</p>
</li>
</ul>
<pre><code class="SQL">--NOMOUNT&amp;OPEN
SYS@prod1&gt; startup nomount
SYS@prod1&gt; alter database mount
SYS@prod1&gt; alter database open

--MOUNT&amp;OPEN
SYS@prod1&gt; startup mount
SYS@prod1&gt; alter database open

--STARTUP
SYS@prod1&gt; startup</code></pre>
<h4 id="实例关闭"><a href="#实例关闭" class="headerlink" title="实例关闭"></a>实例关闭</h4><pre><code class="bash">SYS@prod1&gt; shutdown immediate
SYS@prod1&gt; shutdown abort   ⬅断电，生产环境应避免使用，数据库不会进行同步</code></pre>
<h4 id="动态性能视图"><a href="#动态性能视图" class="headerlink" title="动态性能视图"></a>动态性能视图</h4><ul>
<li>数据库在MOUNT阶段就激活的功能，因为是动态视图，所以其数值的变化会贯穿整个数据库的启动状态.</li>
</ul>
<h4 id="ORACLE-HOME-dbs"><a href="#ORACLE-HOME-dbs" class="headerlink" title="$ORACLE_HOME/dbs"></a>$ORACLE_HOME/dbs</h4><ul>
<li><code>spfile&lt;sid&gt;.ora/init&lt;sid&gt;.ora</code> 初始化文件，后者为文本可读格式的静态文件，后续有详细介绍.</li>
</ul>
<pre><code class="bash">ll $ORACLE_HOME/dbs/
total 10712
-rw-rw---- 1 oracle oinstall     1544 Dec 28 19:03 hc_prod1.dat
-rw-rw---- 1 oracle oinstall     1544 Dec  7 14:22 hc_prodcdb.dat
-rw-r--r-- 1 oracle oinstall     3079 May 15  2015 init.ora
-rw-r--r-- 1 oracle oinstall     1225 Dec 28 19:34 initprod1.ora
-rw-r----- 1 oracle oinstall       24 Nov 13 09:28 lkPROD1
-rw-r----- 1 oracle oinstall       24 Nov 13 10:27 lkPRODCDB
-rw-r----- 1 oracle oinstall     3584 Nov 13 10:05 orapwprod1
-rw-r----- 1 oracle oinstall     3584 Nov 13 11:21 orapwprodcdb
-rw-r----- 1 oracle oinstall 10928128 Dec 28 18:08 snapcf_prod1.f
-rw-r----- 1 oracle oinstall     3584 Jan  4 09:40 spfileprod1.ora
-rw-r----- 1 oracle oinstall     3584 Dec 23 23:11 spfileprodcdb.ora</code></pre>
<hr>
<h3 id="05-实例文件详解"><a href="#05-实例文件详解" class="headerlink" title="05. 实例文件详解"></a>05. 实例文件详解</h3><h4 id="控制文件-Control-Files"><a href="#控制文件-Control-Files" class="headerlink" title="控制文件 Control Files"></a>控制文件 Control Files</h4><pre><code class="SQL">-- SYS@prod1&gt; DESC V$DATAFILE;
-- SYS@prod1&gt; DESC DBA_DATA_FILES;
--查看控制文件路径及数量
SYS@prod1&gt; show parameter control
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
control_file_record_keep_time        integer     7
control_files                        string     /u01/app/oracle/oradata/prod1/control01.ctl, /u01/app/oracle/fast_recovery_area/prod1/control02.ctl
control_management_pack_access        string     DIAGNOSTIC+TUNING</code></pre>
<ul>
<li>控制/新增文件备份</li>
</ul>
<pre><code class="SQL">--二进制备份
SYS@prod1&gt; ALTER DATABASE BACKUP CONTROLFILE TO &#39;/home/oracle/control.ctl&#39;;
--文本备份
SYS@prod1&gt; ALTER DATABASE BACKUP CONTROLFILE TO trace AS &#39;/home/oracle/control.ctl&#39;;
&lt;img src=&quot;control_ctl.png&quot; title=&quot;数据更新流程&quot; alt=&quot;数据更新流程&quot;&gt;


--新增控制文件，数据库进入mount
SYS@prod1&gt; startup mount
ORACLE instance started.
Total System Global Area 1560281088 bytes
Fixed Size            8621088 bytes
Variable Size          989856736 bytes
Database Buffers      553648128 bytes
Redo Buffers            8155136 bytes
Database mounted.

--查看现有控制文件地址及数量
SYS@prod1&gt; show parameter control
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
control_file_record_keep_time         integer     7
control_files                 string     /u01/app/oracle/oradata/prod1/control01.ctl, /u01/app/oracle/fast_recovery_area/prod1/control02.ctl

--新增控制文件control03.ctl 并关闭实例
SYS@prod1&gt; alter system set control_files=&#39;/u01/app/oracle/oradata/prod1/control01.ctl&#39;,&#39;/u01/app/oracle/fast_recovery_area/prod1/control02.ctl&#39;,&#39;/u01/app/oracle/oradata/prod1/control03.ctl&#39; scope=spfile;
SYS@prod1&gt; shutdown immediate


--复制control01文件并rename，和参数中的配置同步
--记住，赋值的文件需是实例关闭后，同步过SNC号的.ctl文件
cp /u01/app/oracle/oradata/prod1/control01.ctl /u01/app/oracle/oradata/prod1/control03.ctl
--重启实例
[oracle@ocp12c ~]$ sqlplus / as sysdba
SYS@prod1&gt; startup mount
ORACLE instance started.
Total System Global Area 1560281088 bytes
Fixed Size            8621088 bytes
Variable Size          989856736 bytes
Database Buffers      553648128 bytes
Redo Buffers            8155136 bytes
Database mounted.
--查看新增control文件后的control参数状态
SYS@prod1&gt; show parameter control
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
control_file_record_keep_time         integer     7
control_files                         string         /u01/app/oracle/oradata/prod1/control01.ctl, /u01/app/oracle/fast_recovery_area/prod1/control02.ctl, /u01/app/oracle/oradata/prod1/control03.ctl

SYS@prod1&gt; alter database open;</code></pre>
<hr>
<ul>
<li>控制文件部分丢失或完全丢失的情况下重建控制文件<br>  ➡ 关闭实例/删除/启动/查看告警/关闭实例<br>  ➡ 复现：先删除某control文件</li>
</ul>
<img src="control1_miss.png" srcset="/img/loading.gif" title="复现某control文件丢失的情况" alt="复现某control文件丢失的情况">

<ul>
<li>启动到mount即可（mount阶段已开始介入control文件）</li>
</ul>
<pre><code class="SQL">[oracle@ocp12c ~]$ sqlplus / as sysdba
SQL*Plus: Release 12.2.0.1.0 Production on Sat Dec 28 18:43:07 2019
Copyright (c) 1982, 2016, Oracle.  All rights reserved.
Connected to an idle instance.  ➡ 再次强调，此时数据库是关闭的！！！后续才可以进行正确的copy！！！
SYS@prod1&gt; startup mount
ORACLE instance started.

Total System Global Area 1560281088 bytes
Fixed Size            8621088 bytes
Variable Size          989856736 bytes
Database Buffers      553648128 bytes
Redo Buffers            8155136 bytes
ORA-00205: error in identifying control file, check alert log for more info</code></pre>
<ul>
<li><p>可以去按照提示，去告警日志里看下原因</p>
<img src="control1_miss2.png" srcset="/img/loading.gif" title="某control文件丢失" alt="某control文件丢失">
</li>
<li><p>恢复丢失的控制文件（在数据库实例完全关闭的情况下！！！）</p>
</li>
</ul>
<pre><code class="BASH">SYS@prod1&gt; shutdown immediate
ORA-01507: database not mounted
ORACLE instance shut down

# 进入到控制文件所在目录，该目录下也包括一些初始化参数文件/密码文件等
cd $ORACLE_BASE/oradata/prod1/
--复制未丢失的control文件并重命名至control01.ctl
cp control03.ctl control01.ctl
--再次重启
SYS@prod1&gt; startup mount</code></pre>
<img src="control1_miss3.png" srcset="/img/loading.gif" title="某control文件丢失恢复" alt="某control文件丢失恢复">

<hr>
<ul>
<li>全部控制文件丢失，需在nomount状态下恢复控制文件，前提是知道redo.log和相关datafile文件的路径</li>
</ul>
<pre><code class="SQL">--找到redo.log和相关datafile文件的路径！！！
SYS@prod1&gt; shutdown immediate;
SYS@prod1&gt; startup nomount;
--执行以下语句
SYS@prod1&gt;
CREATE CONTROLFILE REUSE DATABASE &quot;PROD1&quot; NORESETLOGS ARCHIVELOG
 MAXLOGFILES 16
 MAXLOGMEMBERS 3
 MAXDATAFILES 100
 MAXINSTANCES 8
 MAXLOGHISTORY 292
LOGFILE
 GROUP 1 &#39;/u01/app/oracle/oradata/prod1/redo01.log&#39;,
 GROUP 2 &#39;/u01/app/oracle/oradata/prod1/redo02.log&#39;,
 GROUP 3 &#39;/u01/app/oracle/oradata/prod1/redo03.log&#39;
-- STANDBY LOGFILE
DATAFILE
 &#39;/u01/app/oracle/oradata/prod1/system01.dbf&#39;,
 &#39;/u01/app/oracle/oradata/prod1/sysaux01.dbf&#39;,
 &#39;/u01/app/oracle/oradata/prod1/undotbs01.dbf&#39;,
 &#39;/u01/app/oracle/oradata/prod1/users01.dbf&#39;
CHARACTER SET AL32UTF8;

--打开数据库
SYS@prod1&gt; alter database open;

--下面两步可以在备份的control.ctl文件内找到
--含RESETLOGS参数打开数据库
--简单来说就是加载联机归档日志并重置其log sequence为1，前提是它们存在的话；不存在则创建.
SYS@prod1&gt; ALTER DATABASE OPEN RESETLOGS;
--重新启用临时表空间
-- Commands to add tempfiles to temporary tablespaces.
-- Online tempfiles have complete space information.
-- Other tempfiles may require adjustment.
SYS@prod1&gt; ALTER TABLESPACE TEMP ADD TEMPFILE &#39;/u01/app/oracle/oradata/prod1/temp01.dbf&#39;
     SIZE 67108864  REUSE AUTOEXTEND ON NEXT 655360  MAXSIZE 32767M;</code></pre>
<ul>
<li><p><code>RESETLOGS</code> The RESETLOGS option is always required after incomplete media recovery or recovery using a backup control file. Resetting the redo log does the following:</p>
<ol>
<li><strong>Archives the current online redo logs (if they are accessible) and then erases the contents of the online redo logs and resets the log sequence number to 1.</strong> For example, if the current online redo logs are sequence 1000 and 1001 when you open RESETLOGS, then the database archives logs 1000 and 1001 and then resets the online logs to sequence 1 and 2.</li>
<li><strong>Creates</strong> the online <strong>redo log files</strong> if they do <strong>not currently exist</strong>.</li>
<li><strong>Reinitializes</strong> the control file metadata about online redo logs and redo threads.</li>
<li><strong>Updates all current datafiles and online redo logs</strong> and all subsequent archived redo logs with a new RESETLOGS SCN and time stamp.</li>
</ol>
<p>Because the database will not apply an archived log to a datafile unless the RESETLOGS SCN and time stamps match, the RESETLOGS <strong>prevents you from corrupting datafiles</strong> with archived logs that are not from direct parent incarnations of the current incarnation.</p>
</li>
</ul>
<hr>
<h4 id="数据文件-Data-Files"><a href="#数据文件-Data-Files" class="headerlink" title="数据文件 Data Files"></a>数据文件 Data Files</h4><pre><code class="SQL">--查看相关数据文件及路径
select T.bytes/1024/1024/1024 &quot;TB/(GB)&quot;, T.* FROM DBA_DATA_FILES t /*where t.tablespace_name like &#39;UNDOTBS1%&#39;*/ ORDER BY 2 desc;

--创建特定属性的表空间，后续也有类似的罗列
CREATE TABLESPACE SHIN DATAFILE &#39;/u01/app/oracle/oradata/prod1/shin01.dbf&#39; SIZE 10M 
AUTOEXTEND ON NEXT 10M 
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 1M 
SEGMENT SPACE MANAGEMENT MANUAL;    ⬅ 默认是AUTO
ALTER TABLESPACE SHIN ADD DATAFILE &#39;/u01/app/oracle/oradata/prod1/shin02.dbf&#39; SIZE 10M;</code></pre>
<hr>
<h4 id="联机重做日志文件（归档日志）-redo-log"><a href="#联机重做日志文件（归档日志）-redo-log" class="headerlink" title="联机重做日志文件（归档日志） redo.log"></a>联机重做日志文件（归档日志） redo.log</h4><ul>
<li>修改归档日志路径</li>
</ul>
<pre><code class="SQL">mkdir /u01/app/oracle/archivelog
SYS@prod1&gt; alter system set log_archive_dest_1=&#39;location=/u01/app/oracle/archivelog&#39; socpe=spfile;
SYS@prod1&gt; alter system switch logfile; ⬅手动切换下日志试试，看看新路径下会不会有指定格式的归档日志

SYS@prod1&gt; show parameter log_archive_dest_1;
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
log_archive_dest_1             string     location=/u01/app/oracle/archivelog
log_archive_dest_10             string
log_archive_dest_11             string
log_archive_dest_12             string
log_archive_dest_13             string
log_archive_dest_14             string
log_archive_dest_15             string
log_archive_dest_16             string
log_archive_dest_17             string
log_archive_dest_18             string
log_archive_dest_19             string
--手动切换日志
SYS@prod1&gt; alter system switch logfile;

--进入相关日志路径，查看是否产生了新的日志
ls $ORACLE_BASE/archivelog

--redo log日志组的增加
alter database add logfile group 4 (&#39;/u01/app/oracle/oradata/prod1/redo04_01.log&#39;,&#39;/u01/app/oracle/oradata/prod1/redo04_02.log&#39;) size 50M;


--redo log组新增成员
alter database add logfile member&#39;/u01/app/oracle/oradata/prod1/redo04_03.log&#39;to group 4;


--redo log组删除成员，删除时当前redo log成员的状态为不为CURRENT即可
--查看当前日志成员状态
SYS@prod1&gt; select group#, thread#, sequence#, bytes, members, archived, status from v$log;
--if status(the member that wait to be drop) = CURRENT 
SYS@prod1&gt; alter system switch logfile;
--drop logfile member
ALTER DATABASE DROP LOGFILE MEMBER &#39;/u01/app/oracle/oradata/prod1/redo04_03.log&#39;;


--删除redo log日志组，删除组的条件比删除成员的条件严苛，需要状态为 INACTIVE
--如何将状态切换至INACTIVE? 手动切换当前的 redo.log 日志组，并触发checkpoint同步实例
SYS@prod1&gt; alter system switch logfile;
SYS@prod1&gt; select group#, thread#, sequence#, bytes, members, archived, status from v$log;
--触发checkpoint，同步redo.log内的数据至数据文件内
SYS@prod1&gt; alter system checkpoint;
--此时再执行日志组的删除
SYS@prod1&gt; alter database drop logfile group 4;</code></pre>
<hr>
<h3 id="06-操作系统文件详解"><a href="#06-操作系统文件详解" class="headerlink" title="06. 操作系统文件详解"></a>06. 操作系统文件详解</h3><h4 id="初始化文件"><a href="#初始化文件" class="headerlink" title="初始化文件"></a>初始化文件</h4><ul>
<li><p><code>spfile&lt;sid&gt;.ora</code> </p>
<img src="spfile.png" srcset="/img/loading.gif" title="spfile">
</li>
<li><p><code>init&lt;sid&gt;.ora</code></p>
<img src="pfile.png" srcset="/img/loading.gif" title="pfile">


</li>
</ul>
<h4 id="口令文件"><a href="#口令文件" class="headerlink" title="口令文件"></a>口令文件</h4><h4 id="归档文件"><a href="#归档文件" class="headerlink" title="归档文件"></a>归档文件</h4><pre><code class="SQL">--归档路径查询，这里的log_archive_dest_n为自己配置的路径，一般配置log_archive_dest_1即可
SYS@prod1&gt; show parameter archive
NAME                            TYPE        VALUE
-----------------------------   ----------- ------------------------------
archive_lag_target                integer        0
log_archive_config                string
log_archive_dest                string
log_archive_dest_1                string        location=/u01/app/oracle/archivelog
...                             ...         ...
log_archive_dest_7                string
log_archive_dest_8                string
log_archive_dest_9                string
log_archive_dest_state_1        string        enable
log_archive_dest_state_10        string        enable
...                             ...         ...
log_archive_dest_state_17        string        enable
log_archive_dest_state_18        string        enable
log_archive_dest_state_19        string        enable
log_archive_dest_state_2        string        enable
...                             ...         ...
log_archive_dest_state_3        string        enable
log_archive_dest_state_9        string        enable
log_archive_duplex_dest         string
log_archive_format                string        %t_%s_%r.dbf
log_archive_max_processes        integer        4
log_archive_min_succeed_dest    integer        1
log_archive_start                boolean        FALSE
log_archive_trace                integer        0
standby_archive_dest            string        ?#/dbs/arch</code></pre>
<h4 id="Trace-File-amp-Alter-Log-File"><a href="#Trace-File-amp-Alter-Log-File" class="headerlink" title="Trace File &amp; Alter Log File"></a>Trace File &amp; Alter Log File</h4><pre><code class="SQL">--alert文件和.trc文件如下所示
--第一部分.trc文件在如下命令显示的路径下
SYS@prod1&gt; show parameter dump
NAME                                    TYPE            VALUE
------------------------------------    -----------     ------------------------------
background_core_dump                    string            partial
background_dump_dest                    string            /u01/app/oracle/product/12.2.0/db_1/rdbms/log
core_dump_dest                            string            /u01/app/oracle/diag/rdbms/prod1/prod1/cdump
max_dump_file_size                        string            unlimited
shadow_core_dump                        string            partial
user_dump_dest                            string            /u01/app/oracle/product/12.2.0/db_1/rdbms/log
--user_dump_dest路径下有两组实例的.trc文件
cd /u01/app/oracle/product/12.2.0/db_1/rdbms/log

--alert文件和第二部分.trc文件在下面的路径下
--下面这个路径下也有相关的.trc和alert文件，但是和上述的.trc文件不太类似，生成的时间周期不太一样
cd /u01/app/oracle/diag/rdbms/prod1/prod1/trace</code></pre>
<ul>
<li>两组路径下有不同的.trc文件，有何区别.</li>
</ul>
<hr>
<h3 id="07-数据库逻辑结构"><a href="#07-数据库逻辑结构" class="headerlink" title="07. 数据库逻辑结构"></a>07. 数据库逻辑结构</h3><h4 id="行片段-块-区-段-表空间"><a href="#行片段-块-区-段-表空间" class="headerlink" title="行片段/块/区/段/表空间"></a>行片段/块/区/段/表空间</h4><p><code>行链接</code> 单行数据超过单数据库容纳时，产生行链接.<br><code>行迁移</code> 数据发生update时，产生行迁移，更新的原始行rowid不会发生变化，但整行数据会迁移至新的数据块中，旧的块内会保存指向新块的地址.</p>
<pre><code class="sql">CREATE TABLESPACE &lt;TBSPACE_NAME&gt; DATAFILE &#39;/u01/app/oracle/oradata/prod1/TBSPACE_NAME01.dbf&#39; size 10M
AUTOEXTEND ON NEXT 10M  ⬅ 是指表空间的数据文件大小自动扩展，最大扩充至32G
EXTENT MANAGEMENT LOCAL     ⬅ 区的管理是LOCAL
UNIFORM SIZE 1M             ⬅ 区以后是每次1MB来扩展，即表的实际大小按1MB大小递增
SEGMENT SPACE MANAGEMENT MANUAL     ⬅ 默认是AUTO
--TABLESPACE GROUP GROUP_TMP          ⬅ 一半临时表空间可以配置为临时表空间组，回避单临时表空间不足的问题</code></pre>
<hr>
<h4 id="表空间和数据文件"><a href="#表空间和数据文件" class="headerlink" title="表空间和数据文件"></a>表空间和数据文件</h4><p><code>SYSTEM</code> 不能脱机 offline / 不能置为只读 read only / 不能重命名 / 不能删除</p>
<pre><code class="SQL">create tablespace shin datafile &#39;/u01/&#39;</code></pre>
<p><code>TABLESPACE</code> 常规表空间，建议按需求功能配置不同表空间</p>
<pre><code class="SQL">CREATE TABLESPACE SHIN DATAFILE &#39;/u01/app/oracle/oradata/prod1/shin01.dbf&#39; SIZE 10M 
AUTOEXTEND ON NEXT 10M 
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 1M 
SEGMENT SPACE MANAGEMENT MANUAL;</code></pre>
<hr>
<p><code>TEMP TABLESPACE</code> 临时表空间</p>
<pre><code class="SQL">SYS@prod1&gt; create temporary tablespace tempts1 tempfile &#39;/home/oracle/temp1_02.dbf&#39; size 2M
tablespace group group1;
SYS@prod1&gt; create temporary tablespace tempts2 tempfile &#39;/home/oracle/temp2_02.dbf&#39; size 2M
tablespace group group2;

SYS@prod1&gt; select * from dba_tablespace_groups;
GROUP_NAME TABLESPACE_NAME
------------------------------ ------------------------------
GROUP1 TEMPTS1
GROUP2 TEMPTS2

--将表空间从一个临时表空间组移动到另外一个临时表空间组：
SYS@prod1&gt; alter tablespace tempts1 tablespace group GROUP2 ;
SYS@prod1&gt; select * from dba_tablespace_groups;
GROUP_NAME TABLESPACE_NAME
------------------------------ ------------------------------
GROUP2 TEMPTS1
GROUP2 TEMPTS2</code></pre>
<hr>
<h4 id="段（表-索引-簇等）"><a href="#段（表-索引-簇等）" class="headerlink" title="段（表/索引/簇等）"></a>段（表/索引/簇等）</h4><h4 id="区"><a href="#区" class="headerlink" title="区"></a>区</h4><h4 id="块"><a href="#块" class="headerlink" title="块"></a>块</h4><hr>
<h4 id="高水位线（-High-Water-Mark-HWM）"><a href="#高水位线（-High-Water-Mark-HWM）" class="headerlink" title="高水位线（(High Water Mark, HWM）"></a>高水位线（(High Water Mark, HWM）</h4><p><code>HWM</code> 原则上HWM只会增大，不会缩小.</p>
<ul>
<li><p>相关影响<br>→ 全表扫描通常要读出直到 HWM 标记的所有的属于该表数据库块，即使该表中没有任何数据.<br>→ 即使 HWM 以下有空闲的数据库块，键入在插入数据时使用了 append 关键字，则在插入时使用 HWM 以上的数据块，此时 HWM 会自动增大（插入速度快）.<br>→ HWM会直接影响到相关表空间的大小，即resize表空间时会失败.<br>→ 通常需要我们去优化这些高水位线但实际数据很少的表.</p>
</li>
<li><p><code>HWM</code> 的修正</p>
<img src="HWM.png" srcset="/img/loading.gif" title="HWM修正" alt="HWM修正">

</li>
</ul>
<pre><code class="SQL">--实际数据低于高水位线30%的表的查询
SELECT TABLE_NAME,(BLOCKS*8192/1024/1024)&quot;理论大小 M&quot;,
(NUM_ROWS*AVG_ROW_LEN/1024/1024/0.9)&quot;实际大小 M&quot;,
round((NUM_ROWS*AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS*8192/1024/1024),3)*100||&#39;%&#39; &quot; 实际使用率%&quot;
FROM DBA_TABLES where blocks&gt;100 and (NUM_ROWS*AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS*8192/1024/1024)&lt;0.3 order by (NUM_ROWS*AVG_ROW_LEN/1024/1024/0.9)/(BLOCKS*8192/1024/1024) desc

--重建并收缩
alter table te123 enable ROW MOVEMENT; --表重建，行迁移
alter table te123 shrink space cascade;
--alter database datafile &#39;/u01/app/oracle/oradata/prod1/te123&#39; resize 15M;</code></pre>
<hr>
<h3 id="08-数据库网络配置"><a href="#08-数据库网络配置" class="headerlink" title="08. 数据库网络配置"></a>08. 数据库网络配置</h3><h4 id="监听器（后台服务）"><a href="#监听器（后台服务）" class="headerlink" title="监听器（后台服务）"></a>监听器（后台服务）</h4><ul>
<li><code>监听器</code> 提供数据库对外连接的服务器信息、协议、端口.<br>  主机IP/端口号/全局数据库名/Oracle主目录/SID<br>  全局数据库名：DB_NAME.DB_DOMAIN</li>
</ul>
<pre><code class="bash"># 这部分实验不太理解，先不做解释
SYS@prod1&gt; alter system set db_domain=&#39;oracle.com&#39; scope=spfile;
SYS@prod1&gt; shutdown immediate
SYS@prod1&gt; startup
# SYS@prod1&gt; alter system set global_name=TRUE;

# 网络配置文件位置
cd $ORACLE_HOME/network/admin/</code></pre>
<pre><code class="SQL"># 监听控制
su - oracle
lsnrctl status
lsnrctl stop
lsnrctl start
</code></pre>
<p><code>静态监听</code> 配置文件中有 SID_LIST_LISTENER 就是静态监听.<br><code>静态注册</code> 监听程序启动时读取 listener.ora 文件内容中的实例名(SID_NAME)和服务名（GLOBAL_DBNAME）注册.<br>到监听器中<br><code>动态监听</code> 动态注册默认只注册到默认的监听器上（监听器名称是 LISTENER、端口是 1521、协议是 TCP），如果需要向使用其他协议和端口的监听器注册，则要配置 local_listener 参数动态注册发生的时间：数据库实例启动的时候、每隔一分钟动态注册的进程：PMON.<br><code>手动发起注册命令</code> <code>alter system register;</code></p>
<h4 id="非标准监听配置（LISTENER，port-1522）-amp-客户端网络服务名（TNS）"><a href="#非标准监听配置（LISTENER，port-1522）-amp-客户端网络服务名（TNS）" class="headerlink" title="非标准监听配置（LISTENER，port: 1522）&amp; 客户端网络服务名（TNS）"></a>非标准监听配置（LISTENER，port: 1522）&amp; 客户端网络服务名（TNS）</h4><ul>
<li><code>监听器</code> 提供数据库对外连接的服务器信息、协议、端口.<br>  ➡ 增加监听器 LISTENER1，暂时不增加静态监听到1522端口<br>  ➡ 增加监听tnsname别名 aaa_1（等同于别名监听实验）</li>
</ul>
<pre><code class="bash"># 增加建
cd $ORACLE_HOME/network/admin/
vim listener.ora
# listener.ora
listener.ora
# listener.ora Network Configuration File: /u01/app/oracle/product/12.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = ocp12c)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

# 新增的监听器 LISTENER1
LISTENER1 =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = ocp12c)(PORT = 1522))
    )
  )

SID_LIST_LISTENER =
(SID_LIST =
  (SID_DESC =
   (GLOBAL_DBNAME = prod1)
   (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
   (SID_NAME = prod1)
  )
  (SID_DESC =
   (GLOBAL_DBNAME = prodcdb)
   (ORACLE_HOME = /u01/app/oracle/product/12.2.0/db_1)
   (SID_NAME = prodcdb)
  )
)
######

vim tnsnames.ora
# tnsnames.ora
aaa_1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ocp12c)(PORT = 1522))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = prod1)
    )
  )
######</code></pre>
<ul>
<li>默认的LOCALL监听不会注册至1522端口，故需要我们修改系统参数，修改local_listener参数并手动执行动态注册操作</li>
</ul>
<pre><code class="bash">SYS@prod1&gt; alter system set local_listener=&#39;aaa_1&#39;;     ⬅ 这里的本地监听器，可以使用listener.ora中的别名.

System altered.

SYS@prod1&gt; alter system register;   ⬅ 这里的本地监听器，可以使用listener.ora中的别名.

System altered.</code></pre>
<ul>
<li>启动新监听（port: 1522）</li>
</ul>
<pre><code class="bash">[oracle@ocp12c admin]$ lsnrctl start LISTENER1
[oracle@ocp12c admin]$ lsnrctl status LISTENER1

LSNRCTL for Linux: Version 12.2.0.1.0 - Production on 04-JAN-2020 11:59:41

Copyright (c) 1991, 2016, Oracle.  All rights reserved.


                                                                  ⬇ 这里的监听端口为1522 
Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=ocp12c)(PORT=1522))) 
STATUS of the LISTENER
------------------------
Alias                     LISTENER1
Version                   TNSLSNR for Linux: Version 12.2.0.1.0 - Production
Start Date                04-JAN-2020 11:57:18
Uptime                    0 days 0 hr. 2 min. 22 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /u01/app/oracle/product/12.2.0/db_1/network/admin/listener.ora
Listener Log File         /u01/app/oracle/diag/tnslsnr/ocp12c/listener1/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=ocp12c)(PORT=1522)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcps)(HOST=ocp12c)(PORT=5500))(Security=(my_wallet_directory=/u01/app/oracle/admin/prod1/xdb_wallet))(Presentation=HTTP)(Session=RAW))
Services Summary...
Service &quot;prod1&quot; has 1 instance(s).  ⬅ 服务名
  Instance &quot;prod1&quot;, status READY, has 1 handler(s) for this service...  ⬅ 实例名
Service &quot;prod1XDB&quot; has 1 instance(s).
  Instance &quot;prod1&quot;, status READY, has 1 handler(s) for this service...
The command completed successfully
</code></pre>
<hr>
<p><code>Tips</code> Oracle12c中修改了 <em>local_listener</em> 后，且未将新端口监听添加至静态监听List的情况下，1521和新增且配置了参数后的非1521端口，均可正常本地监听并完成本地连接.</p>
<ul>
<li>修改前</li>
</ul>
<img src="listener.png" srcset="/img/loading.gif" title="local_listener 修改前">

<pre><code class="SQL">SYS@prod1&gt; alter system set local_listener=&#39;aaa_1&#39;;     ⬅ 这里的本地监听器，可以使用listener.ora中的别名.
SYS@prod1&gt; alter system register;   ⬅ 这里的本地监听器，可以使用listener.ora中的别名.
SYS@prod1&gt; show parameter local
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
local_listener                 string     aaa_1
parallel_force_local             boolean     FALSE</code></pre>
<ul>
<li><p>修改后</p>
<img src="listener2.png" srcset="/img/loading.gif" title="local_listener 修改后，两者可并存">
</li>
<li><p>客户端连接测试</p>
<img src="listener3.png" srcset="/img/loading.gif" title="local_listener 修改后，两者可并存">

</li>
</ul>
<hr>
<ul>
<li>拓展：增加服务名，用于建立用户与实例的桥梁</li>
</ul>
<pre><code class="SQL">SYS@prod1&gt; show parameter service_names
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
service_names                 string     prod1

SYS@prod1&gt; alter system set service_names=&#39;prod1,aaa&#39;;
SYS@prod1&gt; show parameter service_names
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
service_names                 string     prod1,aaa</code></pre>
<hr>
<ul>
<li>总结：</li>
</ul>
<ol>
<li><code>服务名</code> 服务名的建立连接了用户进程与实例，我们可以给一组实例配置多个服务名，并且动态注册到监听中，用于非本地客户端的连接. 如<code>拓展</code>中所示，我们给实例添加了一组额外的服务名，这时候我们便可以通过这组service_name去连接实例. <code>相当于是这样</code>: 在数据库服务器和客户端之间有一监听程序（Listener），在监听程序中，会记录相应数据库对应的服务名（一个数据库可能对应有多个服务名），当客户端需要连接数据库时，只需要提供服务名，就可以建立客户端和服务器之间的连接.</li>
</ol>
<pre><code class="SQL">SYS@prod1&gt; show parameter service_names
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
service_names                 string     prod1,aaa

-- 通过新增的aaa连接prod1实例
sqlplus hr/oracle@192.168.73.101:1521/aaa
sqlplus hr/oracle@192.168.73.101:1521/prod1
    --这里的service_name = prod1，       ⬆
    --碰巧和实例名prod1相同，不要混淆！！！  </code></pre>
<hr>
<ol start="2">
<li>过分麻烦的IP/port/service_name/系统目录等连接信息，会让实例的连接变得繁琐，通过tnsnames.ora中的网络别名配置，有效简化了实例连接. 别名样例详见<code>客户端网络服务名（TNS）</code>.</li>
</ol>
<pre><code class="SQL">-- tnsnames.ora
prod1 =     ⬅ 简单连接命名 = prod1
  (DESCRIPTION = 
    (ADDRESS = (PROTOCOL = TCP)(HOST = ocp12c)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = prod1)
    )
  )

aaa_1 =     ⬅ 简单连接命名 = aaa_1
  (DESCRIPTION =                                        ⬇ 这里的监听端口为非标准的1522
    (ADDRESS = (PROTOCOL = TCP)(HOST = ocp12c)(PORT = 1522))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = aaa)
                       ⬆ --这里监听的service_name = aaa，
                         --等同于prod1，因为实例prod1我们配置了两组service_name
    )
  )
------

--通过配置tnsnames.ora，开启别名连接
sqlplus hr/oracle@192.168.73.101:1521/aaa
sqlplus hr/oracle@192.168.73.101:1521/prod1

--上述连接方式简化为
sqlplus hr/oracle@aaa_1
sqlplus hr/oracle@prod1</code></pre>
<hr>
<ol start="3">
<li>新增监听器<strong>LISTENER1</strong>并且配置<strong>local_listener</strong>，使得非标准端口动态注册成为现实，详见<code>非标准监听配置（LISTENER，port: 1522）</code>. 这里有一个12c可能存在的新特性，配置<strong>local_listener</strong>为 <strong><em>1521</em></strong> 端口下的<strong>aaa_1</strong>（即<strong>LISTENER1</strong>）后，原始 <strong><em>1521</em></strong>端口下的默认监听器<strong>LISTENER</strong>依旧允许用户登入. 详见<code>非标准监听配置（LISTENER，port: 1522）➡ 修改后 &amp; 客户端连接测试</code></li>
</ol>
<pre><code class="SQL">sqlplus hr/oracle@192.168.73.101:1521/prod1
sqlplus hr/oracle@prod1 ⬅ (prod1 ➡ service_name: prod1 ➡ instance:prod1)

sqlplus hr/oracle@192.168.73.101:1522/aaa
sqlplus hr/oracle@aaa_1 ⬅ (aaa_1 ➡ service_name: aaa   ➡ instance:prod1)</code></pre>
<hr>
<h3 id="09-CDB-PDB"><a href="#09-CDB-PDB" class="headerlink" title="09. CDB/PDB"></a>09. CDB/PDB</h3><h4 id="CDB-VS-PDB"><a href="#CDB-VS-PDB" class="headerlink" title="CDB VS PDB"></a>CDB VS PDB</h4><ul>
<li>CDB中的PDB文件</li>
</ul>
<p>数据文件的共享：12c之前，PDB复用CDB的所有文件，包括redo和control复用CDB的文件，spfile/密码等文件，PDB复用CDB的文件</p>
<pre><code class="SQL">--PDB复用部分CDB数据文件
cd /u01/app/oracle/oradata/prodcdb

--spfile/密码等文件，PDB复用CDB的文件
cd /u01/app/oracle/product/12.2.0/db_1/dbs</code></pre>
<img src="PDB复用.png" srcset="/img/loading.gif" title="PDB oradata数据文件的复用">
<img src="PDB复用2.png" srcset="/img/loading.gif" title="PDB 初始化文件的复用">
<img src="PDB&CDB.png" srcset="/img/loading.gif" title="多租户容器数据库体系结构">

<p><code>Tips</code>12.2之后的版本，PDB默认有自己的undo表空间（local undo），若没有自己的undo，则会share CDB$ROOT 中的undo.</p>
<ul>
<li><code>小结</code><ol>
<li>控制文件/联机重做日志/参数文件属于CDB（根：CDB&amp;ROOT），不属于PDB，PDB复用.</li>
<li>位于根而不在PDB中的文件：RAC数据库所有实例的undo，Oracle提供的元数据，CDB视图，CDB资源管理计划.</li>
<li>位于PDB而不在根中的文件：PDB系统表空间（含sysaux），PDB临时/用户表空间.</li>
</ol>
</li>
</ul>
<p><code>疑问</code>PDB的<code>undo</code>应该也是属于各自PDB的，12.1中共享，12.2之后各自独立.（解决）</p>
<h4 id="CDB-PDB（配置-增删）"><a href="#CDB-PDB（配置-增删）" class="headerlink" title="CDB/PDB（配置/增删）"></a>CDB/PDB（配置/增删）</h4><hr>
<ul>
<li>PDB&amp;CDB查看/切换</li>
</ul>
<pre><code class="SQL">--查看当前是否为PDB
--若有PDB$SEED，则说明当前为PRODCDB
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
SYS@prodcdb&gt; show conn_name;
CON_NAME
------------------------------
CDB$ROOT
SYS@prodcdb&gt; show con_id;
CON_ID
------------------------------
1

--切换至PDB
SYS@prodcdb&gt; alter session set container=PRODPDB;
Session altered.
--查看，此时只有当前的PDB
SYS@prodcdb&gt; show pdbs; 
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
3 PRODPDB              READ WRITE NO
SYS@prodcdb&gt; show conn_name;
CON_NAME
------------------------------
PRODPDB
SYS@prodcdb&gt; show con_id;
CON_ID
------------------------------
3

--切换回CDB
SYS@prodcdb&gt; alter session set container=CDB$ROOT;
Session altered.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO</code></pre>
<hr>
<ul>
<li>新建/删除PDB的service_name</li>
</ul>
<pre><code class="SQL">--在容器数据库下可以进行全局的服务名查询
SYS@prodcdb&gt; select name, pdb from cdb_services;
SYS@prodcdb&gt; select name, pdb from v$services;
NAME       PDB
---------- ----------
SYS$BACKGR CDB$ROOT
OUND

SYS$USERS  CDB$ROOT
prodcdbXDB CDB$ROOT
prodcdb    CDB$ROOT
prodpdb    PRODPDB
shin       PRODPDB


--尝试给CDB下的PDB实例新建一个service_name
--查看创建前PDB对应的service_name
SYS@prodcdb&gt; alter session set container=PRODPDB;
Session altered.
SYS@prodcdb&gt; col name format a10;
SYS@prodcdb&gt; col pdb format a10;
SYS@prodcdb&gt; select name, pdb from cdb_services;
NAME       PDB
---------- ----------
prodpdb    PRODPDB

--创建新的PDB服务名
SYS@prodcdb&gt; exec dbms_service.create_service(&#39;shin&#39;,&#39;shin&#39;);
PL/SQL procedure successfully completed.
SYS@prodcdb&gt;  select name,pdb from cdb_services;
NAME       PDB
---------- ----------
prodpdb    PRODPDB
shin       PRODPDB</code></pre>
<ul>
<li>但是此时去查看系统监听，并没有看到服务名shin（Instance：prodpdb）的服务被动态注册到监听中，需要启动新的服务.</li>
</ul>
<img src="新建一个PDB的service_name.png" srcset="/img/loading.gif" title="new pdb service_name">

<hr>
<pre><code class="SQL">--启动新PDB下的服务名
SYS@prodcdb&gt; exec dbms_service.START_SERVICE(&#39;shin&#39;);
PL/SQL procedure successfully completed.</code></pre>
<img src="启动新的PDB的service.png" srcset="/img/loading.gif" title="active new pdb service_name">
<img src="启动新的PDB的service2.png" srcset="/img/loading.gif" title="active new pdb service_name">

<hr>
<p><code>Tips</code>先关闭服务，再删除服务.</p>
<pre><code class="SQL">SQL&gt; alter session set container=prodpdb;
Session altered.
SQL&gt; exec dbms_service.stop_service(&#39;shin&#39;);
PL/SQL procedure successfully completed.
SQL&gt; exec dbms_service.delete_service(&#39;shin&#39;);</code></pre>
<ul>
<li>CDB/PDB下连接各用户</li>
</ul>
<pre><code class="SQL">--切换实例环境，目前有该服务器上有两组数据库实例，prod1 &amp; prodcdb
[oracle@ocp12c ~]$ . oraenv
ORACLE_SID = [prodpdb] ? prodcdb
The Oracle base remains unchanged with value /u01/app/oracle
[oracle@ocp12c ~]$ sqlplus / as sysdba

SQL*Plus: Release 12.2.0.1.0 Production on Sat Jan 11 11:21:32 2020

Copyright (c) 1982, 2016, Oracle.  All rights reserved.


Connected to:
Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production

SYS@prodcdb&gt; 


--开始测试连接方式
--服务名方式连接
--conn usr/pwd@ip:port/service_name
SYS@prodcdb&gt; conn test/oracle@ocp12c:1521/prodpdb;
Connected.
SYS@ocp12c:1521/prodcdb&gt; conn test/oracle@ocp12c:1521/prodpdb;
Connected.
TEST@ocp12c:1521/prodpdb&gt; conn test/oracle@ocp12c:1521/shin;
Connected.
TEST@ocp12c:1521/shin&gt; conn sys/oracle@ocp12c:1521/prodcdb as sysdba;
Connected.
SYS@ocp12c:1521/prodcdb&gt; 

--TNS别名方式连接
--conn usr/pwd@tns
SYS@ocp12c:1521/prodcdb&gt; conn test/oracle@prodpdb;
Connected.
TEST@prodpdb&gt; conn sys/oracle@prodcdb as sysdba;
Connected.
SYS@prodcdb&gt; 
--PDB PRODPDB 对应的新服务名shin 没有在tnsnames.ora中设置服务名别名，故不能用本方法连接</code></pre>
<hr>
<ul>
<li>OMF VS 非OMF<br><code>OMF</code>Oracle文件管理，文件名系统生成，从<code>/u01/app/oracle/oradata</code>后的路径就开始自动生成，不合并到CDB容器路径<code>/u01/app/oracle/oradata/prodcdb</code>下，而是自动生成新的路径<code>/u01/app/oracle/ORADATA/prodcdb</code>），详情看下图.<img src="OMF_PDB_create.png" srcset="/img/loading.gif"  width="300" >


</li>
</ul>
<hr>
<ul>
<li>新建CDB</li>
</ul>
<p><strong><em>手工方式创建</em></strong><br>新子句 <code>SEED FILE_NAME_CONVERT</code><br>新实例参数 <code>PDB_FILE_NAME_CONVERT</code><br>OMF模式（数据实例参数） <code>DB_CREATE_FILE_DEST</code></p>
<pre><code class="SQL"></code></pre>
<p><strong><em>DBCA方式创建</em></strong></p>
<pre><code class="bash">dbca -silent -createDatabase -templateName General_Purpose.dbc -responseFile NO_VALUE \
 -gdbname PRODCDB2 -sid PRODCDB2 \  ⬅ 数据库名 &amp; 实例名
 -createAsContainerDatabase TRUE \  ⬅ 创建为CDB
 -sysPassword oracle -systemPassword oracle \
 -datafileDestination &#39;/u01/app/oracle/oradata&#39; \ ⬅ 数据路径配置
 -recoveryAreaDestination &#39;/u01/app/oracle/flash_recovery_area&#39; \ ⬅ redo.log路径配置，原始路径名为`/u01/app/oracle/fast_recovery_area`
 -redoLogFileSize 50 \
 -storageType FS \
 -characterset ZHS16GBK -nationalCharacterSet AL16UTF16 \
 -sampleSchema true \
 -totalMemory 1024 \
 -databaseType OLTP \
 -emConfiguration NONE</code></pre>
<p><strong><em>DBCA方式删除</em></strong></p>
<pre><code class="bash">dbca -silent -deleteDatabase -sourceDB PRODCDB2 -sysDBAUserName sys -sysDBAPassword oracle -forceArchiveLogDeletion</code></pre>
<p><strong><em>非DBCA方式创建（老师口述，暂未做实验）</em></strong></p>
<pre><code class="SQL">ALTER PLUGGABLE DATABASE PRODPDB OPEN RESTRICTED;
drop database;

</code></pre>
<hr>
<ul>
<li>新建PDB（从PDB$SEED生成PDB）</li>
</ul>
<p><strong><em>位置子句</em></strong>  </p>
<p>OMF模式<code>CREATE_FILE_DEST</code></p>
<pre><code class="SQL">SYS@PRODCDB2&gt; create pluggable database PRODPDB2 admin user oracle identified by oracle CREATE_FILE_DEST=&#39;/u01/app/oracle/oradata&#39;;</code></pre>
<img src="OMF_PDB_create3.png" srcset="/img/loading.gif"  width="300" title="PRODPDB2，位置子句下的OMF模式创建">



<p>非OMF模式<code>FILE_NAME_CONVERT</code></p>
<pre><code class="SQL">SYS@PRODCDB2&gt; create pluggable database PRODPDB3 admin user oracle identified by oracle roles=(dba) FILE_NAME_CONVERT=(&#39;/u01/app/oracle/oradata/PRODCDB2/pdbseed&#39;,&#39;/u01/app/oracle/oradata/PRODCDB2/prodpdb3&#39;);
Pluggable database created.
SYS@PRODCDB2&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB2              MOUNTED
4 PRODPDB3              MOUNTED   ⬅ </code></pre>
<p><strong><em>非位置子句</em></strong></p>
<p>OMF模式 <code>DB_CREATE_FILE_DEST</code></p>
<pre><code class="SQL">SYS@PRODCDB2&gt; alter session set DB_CREATE_FILE_DEST=&#39;/u01/app/oracle/oradata&#39;;
Session altered.
SYS@PRODCDB2&gt; create pluggable database prodpdb4 admin user oracle identified by oracle default tablespace users;
Pluggable database created.

SYS@PRODCDB2&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB2              MOUNTED
4 PRODPDB3              MOUNTED
5 PRODPDB4              MOUNTED   ⬅ </code></pre>
<img src="OMF_PDB_create2.png" srcset="/img/loading.gif"  width="300" title="PRODPDB4，非位置子句下的OMF模式创建">


<p>非OMF模式 <code>PDB_FILE_NAME_CONVERT</code></p>
<pre><code class="SQL">SYS@prodcdb2&gt; alter session set pdb_file_name_convert=&#39;/u01/app/oracle/oradata/PRODCDB2/pdbseed&#39;,&#39;/u01/app/oracle/oradata//PRODCDB2/prodpdb5&#39;;
Session altered.
SYS@prodcdb2&gt; create pluggable database prodpdb5 admin user oracle identified by oracle;
Pluggable database created.
SYS@prodcdb2&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB2              MOUNTED
4 PRODPDB3              MOUNTED
5 PRODPDB4              MOUNTED
6 PRODPDB5              MOUNTED</code></pre>
<hr>
<ul>
<li>克隆PDB（clone from PDB existed）</li>
</ul>
<p><strong><em>位置子句</em></strong></p>
<p>OMF模式：</p>
<pre><code class="SQL">SYS@prodcdb&gt; create pluggable database PRODPDB6 from PRODPDB CREATE_FILE_DEST = &#39;/u01/app/oracle/oradata&#39;;
Pluggable database created.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED</code></pre>
<p>非OMF模式：</p>
<pre><code class="SQL">SYS@prodcdb&gt; create pluggable database prodpdb7 from prodpdb file_name_convert=(&#39;/u01/app/oracle/prodcdb/prodpdb&#39;,&#39;/u01/app/oracle/oradata/prodcdb/prodpdb7&#39;);
Pluggable database created.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              READ WRITE NO
7 PRODPDB7              MOUNTED</code></pre>
<p><strong><em>非位置子句</em></strong></p>
<p>OMF模式：</p>
<pre><code class="SQL">SYS@prodcdb&gt; alter pluggable database PRODPDB7 open;     
Pluggable database altered.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
7 PRODPDB7              READ WRITE NO
SYS@prodcdb&gt;  alter session set DB_CREATE_FILE_DEST =&#39;/u01/app/oracle/oradata&#39;;
Session altered.
SYS@prodcdb&gt;  create pluggable database prodpdb8 from prodpdb7;
Pluggable database created.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
5 PRODPDB8              MOUNTED
7 PRODPDB7              READ WRITE NO</code></pre>
<p><code>Tips</code>一个全局PDB启动时，由OMF创建格式带来的BUG<br><img src="OMF_PDB_create_BUG.png" srcset="/img/loading.gif"  width="300" title="一个全局PDB启动时，由OMF创建格式带来的BUG."></p>
<p>非OMF模式：</p>
<pre><code class="SQL">SYS@prodcdb&gt; alter session set DB_CREATE_FILE_DEST=&#39;&#39;;
Session altered.
SYS@prodcdb&gt; show parameter create;

NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
create_bitmap_area_size          integer     8388608
create_stored_outlines             string
db_create_file_dest             string
db_create_online_log_dest_1         string
db_create_online_log_dest_2         string
db_create_online_log_dest_3         string
db_create_online_log_dest_4         string
db_create_online_log_dest_5         string
SYS@prodcdb&gt; alter session set pdb_file_name_convert=&#39;/u01/app/oracle/oradata/prodcdb/p/oracle/oradata/prodcdb/prodpdb9&#39;;
Session altered.
SYS@prodcdb&gt; show parameter pdb_file_name_convert;
NAME                     TYPE     VALUE
------------------------------------ ----------- ------------------------------
pdb_file_name_convert             string     /u01/app/oracle/oradata/prodcdb/prodpdb7, /u01/app/oracle/oradata/prodcdb/prodpdb9

SYS@prodcdb&gt; create pluggable database prodpdb9 from prodpdb7;
Pluggable database created.
SYS@prodcdb&gt; show pdbs  
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
5 PRODPDB8              MOUNTED
6 PRODPDB9              MOUNTED
7 PRODPDB7              READ WRITE NO
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
5 PRODPDB8              MOUNTED
6 PRODPDB9              MOUNTED
7 PRODPDB7              READ WRITE NO
8 PRODPDB10              READ WRITE NO</code></pre>
<ul>
<li>删除PDB</li>
</ul>
<pre><code class="SQL">SYS@prodcdb&gt; alter pluggable database prodpdb9 close immediate;
Pluggable database altered.
SYS@prodcdb&gt; show pdbs;

CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
5 PRODPDB8              MOUNTED
6 PRODPDB9              MOUNTED
7 PRODPDB7              READ WRITE NO
8 PRODPDB10              READ WRITE NO
SYS@prodcdb&gt; drop pluggable database prodpdb9 including datafiles;
Pluggable database dropped.
SYS@prodcdb&gt; show pdbs;
CON_ID CON_NAME              OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
2 PDB$SEED              READ ONLY  NO
3 PRODPDB              READ WRITE NO
4 PRODPDB6              MOUNTED
5 PRODPDB8              MOUNTED
7 PRODPDB7              READ WRITE NO
8 PRODPDB10              READ WRITE NO</code></pre>
<ul>
<li>12.2热克隆<br>上述克隆方式均为read write模式下的热克隆.</li>
</ul>
<hr>
<h4 id="多租户CDB-PDB的相关管理（配置-增删）"><a href="#多租户CDB-PDB的相关管理（配置-增删）" class="headerlink" title="多租户CDB/PDB的相关管理（配置/增删）"></a>多租户CDB/PDB的相关管理（配置/增删）</h4><ul>
<li><p>PDB相关拔插实验还未完成</p>
</li>
<li><p>CDB关闭与开启（类似于单实例操作）</p>
</li>
<li><p>PDB关闭与自启</p>
</li>
</ul>
<p><code>SAVE STATE</code>打开<strong>指定PDB</strong>，使用<strong>SAVE STATE</strong>子句保存PDB的最后打开状态.</p>
<pre><code class="SQL">ALTER PLUGGABLE DATABASE PRODPDB OPEN;
ALTER PLUGGABLE DATABASE PRODPDB SAVE STATE;

--所有PDB均自启
ALTER PLUGGABLE DATABASE all OPEN;
ALTER PLUGGABLE DATABASE all SAVE STATE;
--还原，不再保存PDB的最后打开状态
ALTER PLUGGABLE DATABASE all DISCARD STATE;


--立即关闭
alter pluggable database prodpdb close immediate;
--除去某个PDB外均关闭
alter pluggable database all except prodpdb close;
--正常全关闭
alter pluggable database all close; 
--断电（PDB不同于CDB，断电后需要恢复介质！！！）
alter pluggable database prodpdb close abort;
alter pluggable database prodpdb open;
recover database --recover datafile
--或在 rman 里执行：recover pluggable database prodpdb;</code></pre>
<ul>
<li>PDB开启模式</li>
</ul>
<pre><code class="SQL">--受限模式打开（sys/system用户）
ALTER PLUGGABLE DATABASE PRODPDB OPEN RESTRICTED;
--只读
ALTER PLUGGABLE DATABASE PRODPDB OPEN READ ONLY;
--读写
ALTER PLUGGABLE DATABASE PRODPDB OPEN;

--PDB_SPFILE$</code></pre>
<ul>
<li>临时还原（不太用）<pre><code class="SQL">ALTER SYSTEM SET TEMP_UNDO_ENABLE=TRUE;</code></pre>
</li>
</ul>
<hr>
<h3 id="10-安全"><a href="#10-安全" class="headerlink" title="10. 安全"></a>10. 安全</h3><h4 id="Schema-profile"><a href="#Schema-profile" class="headerlink" title="Schema profile"></a>Schema profile</h4><ul>
<li>常用的两组profile参数修改</li>
</ul>
<pre><code class="SQL">alter PROFILE default LIMIT PASSWORD_LIFE_TIME unlimited;
alter PROFILE default LIMIT FAILED_LOGIN_ATTEMPTS 100;</code></pre>
<ul>
<li><p>密码限制</p>
<img src="schema_profile.png" srcset="/img/loading.gif"  width="300" title="密码限制.">
</li>
<li><p>资源限制</p>
<img src="schema_profile2.png" srcset="/img/loading.gif"  width="300" title="资源限制.">

</li>
</ul>
<h4 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h4><p><code>权限分类</code>系统权限/对象权限</p>
<pre><code class="SQL">grant connect,resource,create view to test</code></pre>
<ul>
<li>系统权限</li>
</ul>
<p><code>with admin option</code>系统权限转授，即被赋予某权限的用户拥有赋予其它schema相同权限的能力.<br><code>Tips</code>系统权限被收回时，后续级联的权限<strong>不会</strong>被回收！！！</p>
<pre><code class="SQL">create user test1 identified by oracle;
create user test2 identified by oracle;
grant connect,resource,create view to test1 with admin option;
sqlplus test1/oracle@prod1;
grant connect,resource,create view to test2;</code></pre>
<ul>
<li>对象权限</li>
</ul>
<p><code>with grant option</code>对象权限转授，即被赋予某权限的用户拥有赋予其它schema相同权限的能力.<br><code>Tips</code>对象权限被收回时，后续级联的权限<strong>会</strong>被回收！！！</p>
<h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><p><code>角色</code>即不同权限的集合体.<br><img src="预定义角色.png" srcset="/img/loading.gif"  width="300" title="预定义角色."></p>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Oracle12c">Oracle12c</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "20200104_0956-Oracle12cR2（持续更新）&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>











</body>
</html>
