<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/shin.png">
  <link rel="icon" type="image/png" href="/img/shin.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="Shinnosuke Guo">
  <meta name="keywords" content="">
  <title>20200323_1205_Python3-Kafka-Producer ~ Shinnosuke</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Shinnosuke</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/archive.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Wednesday, April 8th 2020, 1:16 pm
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    2.7k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      15 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h2 id="Python3-KafkaProducer-with-PostgreSQL"><a href="#Python3-KafkaProducer-with-PostgreSQL" class="headerlink" title="Python3 KafkaProducer_with_PostgreSQL"></a>Python3 KafkaProducer_with_PostgreSQL</h2><h3 id="01-数据库数据采集-amp-监控"><a href="#01-数据库数据采集-amp-监控" class="headerlink" title="01. 数据库数据采集&amp;监控"></a>01. 数据库数据采集&amp;监控</h3><ul>
<li><p>Repo Point<br>  kafka-python<br>  psycopg2</p>
</li>
<li><p>class_Kafka_producer.py</p>
</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/3/23 10:13
# @File: class_Kafka_producer.py
# @Usage: Kafka producer for kafka_2.11-0.10.2.1

from kafka import KafkaProducer
import pymysql as pym
# import psycopg2 as pg

# Self Repo
from src.func_demo.func_f import date_f
from src.func_demo.logging_f import *
from src.conf import kafka_conf as cfg
# from func_demo.func_f import date_f
# from func_demo.logging_f import *
# from conf import kafka_conf as cfg


class KafkaProducerPython(object):

    def __init__(self, topic, bootstrap_servers=&#39;localhost:9092&#39;):
        &quot;&quot;&quot;
        :param bootstrap_servers:   host:port for Kafka
        :param topic:   Kafka topic
        &quot;&quot;&quot;
        self.bootstrap_servers = bootstrap_servers
        self.topic = topic
        self.producer = None
        self.future_record_metadata = None

    def producer_send(self, value_byte):
        &quot;&quot;&quot;
        :param value_byte:  str or json_str in bytes
        :return:    &lt;class &#39;kafka.producer.future.FutureRecordMetadata&#39;&gt;
        &quot;&quot;&quot;
        try:
            self.producer = KafkaProducer(bootstrap_servers=self.bootstrap_servers)
            log.logger.warning(f&#39;Kafka Producer Begin: {self.producer}&#39;)

            self.future_record_metadata = self.producer.send(self.topic, value_byte)   # &lt;class &#39;kafka.producer.future.FutureRecordMetadata&#39;&gt;
            # print(type(self.future_record_metadata))
            return self.future_record_metadata

        except Exception as e:
            log.logger.error(f&#39;Kafka producer send error... {e}&#39;)
        finally:
            self.producer.flush()

    def producer_send_callback(self, future_record_metadata):
        &quot;&quot;&quot;
        :param future_record_metadata: &lt;class &#39;kafka.producer.future.FutureRecordMetadata&#39;&gt; producer.send 返回
        :return:
        &quot;&quot;&quot;
        # log = Logger(filename = f&#39;./logs/all_bokeh.log&#39;, level=&#39;info&#39;, when=&#39;H&#39;)
        log.logger.info(f&#39;future_record_metadata.topic: {future_record_metadata.topic}&#39;)
        log.logger.info(f&#39;future_record_metadata.offset: {future_record_metadata.offset}&#39;)
        log.logger.info(f&#39;future_record_metadata.partition: {future_record_metadata.partition}&#39;)
        log.logger.warning(f&#39;Kafka Producer End: {self.producer}\n&#39;)


        # def on_send_err(self):
        # log.logger.info(&#39;I am an errback&#39;, exc_info=excp)

    def to_bytes(self, v):
        v_byte = bytes(str(v), encoding=&#39;utf-8&#39;)
        return v_byte
        # return str(v)


    def to_str(self, v):
        return str(v)


if __name__ == &#39;__main__&#39;:
    # 类模式
    data_dict = {&quot;res_type&quot;:&quot;24&quot;,
                 &quot;res_key&quot;:&quot;10001&quot;,
                 &quot;kpi_id&quot;:&quot;5000200010001&quot;,
                 &quot;time&quot;:&quot;2020-01-14 10:24:00&quot;,
                 &quot;value&quot;:&quot;60&quot;,
                 &quot;vendor&quot;:&quot;华为&quot;,
                 &quot;city&quot;:&quot;531&quot;
    }
    # print(f&#39;{data_dict[&quot;res_key&quot;]} {type(data_dict[&quot;res_key&quot;])}\n&#39;)

    # # Demo
    # try:
    prod = KafkaProducerPython(topic=cfg.kafka_cfg_dict[&#39;topic&#39;],
                               bootstrap_servers=cfg.kafka_cfg_dict[&#39;bootstrap_servers&#39;])
    #
    # dict ---&gt; bytes # ✔✔✔✔✔✔
    # kafka_str2bytes = prod.to_bytes(f&#39;\n{date_f()[2]}    This is from Python project class_Kafka_producer...\n{data_dict}&#39;)
    kafka_str2bytes = prod.to_bytes(f&#39;\n{date_f()[2]}    This is from Python project class_Kafka_producer...&#39;)

    #
    #     # dict ---&gt; json ---&gt; bytes
    #     # Chinese in Consumer need to be decoded  # ××××××
    #     data_json2bytes = json.dumps(data_dict).encode(&#39;utf-8&#39;)
    #
    #
    x = prod.producer_send(kafka_str2bytes)
    x.add_callback(prod.producer_send_callback)

    # oltp_mysql_matser = None
    sql1 = cfg.sql_map[&quot;sql1&quot;]
    sql2 = cfg.sql_map[&quot;sql2&quot;]

    try:
        # 3. Kafka producer
        prod = KafkaProducerPython(topic=cfg.kafka_cfg_dict[&#39;topic&#39;],
                                   bootstrap_servers=cfg.kafka_cfg_dict[&#39;bootstrap_servers&#39;])

        # 1. MySQL execution
        # MySQL结果转json
        global oltp_mysql_matser
        # oltp_mysql_matser = pym.connect(host=&#39;192.168.73.21&#39;, user=&#39;root&#39;, passwd=&#39;123456&#39;, db=&#39;MURA&#39;, port=3306)

        oltp_mysql_matser = pym.connect(host=cfg.mysql_conn[&quot;host&quot;], user=cfg.mysql_conn[&quot;user&quot;],
                                            passwd=cfg.mysql_conn[&quot;passwd&quot;], db=cfg.mysql_conn[&quot;db&quot;],
                                            port=cfg.mysql_conn[&quot;port&quot;])


        log.logger.warning(f&#39;MySQL Begin: {oltp_mysql_matser}&#39;)

        cursor1 = oltp_mysql_matser.cursor()
        cursor2 = oltp_mysql_matser.cursor()

        cursor1.execute(sql1)
        rowcnt = cursor1.rowcount   # cursor2.execute(sql2)

        # 2. 分批，不知是否合理
        rows = cursor2.fetchone()
        # log.logger.info(f&#39;Total rows for current execution &lt;{sql2}&gt;: {[x for x in rows]}&#39;)
        log.logger.info(f&#39;Total rows for current execution &lt;{sql1}&gt;: {rowcnt}&#39;)

        execute_result_1 = cursor1.fetchmany(rows[0]) # &lt;class &#39;tuple&#39;&gt;
        execute_result_2 = cursor1.fetchall()

        cursor1.close()
        cursor2.close()

        # print(type(execute_result_1))
        mysql_dict_list =[]
        mysql_dict_list_2 = []
        for rn in execute_result_1:
            mysql_dict = {}
            mysql_dict[&quot;res_type&quot;] = str(rn[0])
            mysql_dict[&quot;res_key&quot;] = rn[1]
            mysql_dict[&quot;kpi_id&quot;] = rn[2]
            mysql_dict[&quot;time&quot;] = str(rn[3])
            mysql_dict[&quot;value&quot;] = str(rn[4])
            mysql_dict[&quot;vendor&quot;] = rn[5]
            mysql_dict[&quot;city&quot;] = str(rn[6])

            mysql_dict_list.append(prod.to_bytes([mysql_dict]))
        # dict ---&gt; bytes
        for rb in mysql_dict_list:
            prod.producer_send(rb).add_callback(prod.producer_send_callback)
            # print(f&#39;rb: {rb} {type(rb)}\n&#39;)

    except Exception as e:
        log.logger.error(f&#39;{e}\n&#39;)
        errlog.logger.error(f&#39;{e}&#39;)
    finally:
        oltp_mysql_matser.close()
        log.logger.warning(f&#39;MySQL End: {oltp_mysql_matser}&#39;)


    # # 手动模式
    # prod = KafkaProducer(bootstrap_servers=&#39;192.168.73.10:9092&#39;)
    # for _ in range(3):
    #     prod.send(topic=&#39;test&#39;, value=b&#39;This is from Python project class_Kafka_producer...&#39;)
    # # prod = KafkaProducer(value_serializer=lambda x: json.dumps(x).encode(&#39;utf-8&#39;))
    # prod.send(&#39;test&#39;, data_json)


    # # Block until all pending messages are at least put on the network
    # # NOTE: This does not guarantee delivery or success! It is really
    # # only useful if you configure internal batching using linger_ms
    # prod.flush()</code></pre>
<hr>
<ul>
<li>class_DB_demo.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/3/29 12:19
# @File: class_DB_demo.py
# @Usage: 


import pymysql as pm
import psycopg2 as pg
from psycopg2.extras import execute_values


# Self Repo
from src.func_demo.logging_f import *


# 下面的三行包其实是main函数中使用，有部分重复
# Self Repo
# from src.class_DB_demo import UseMySQL, UsePostgreSQL, ExecutePostgreSQL
from src.conf.kafka_conf import mysql_conn, pgsql_conn, pgsql_conn_pp, pgsql_conn_prod
from src.func_demo.logging_f import *


class UseMySQL(object):
    def __init__(self, config:dict):
        self.configurantion = config

    def __enter__(self):
        self.conn = pm.connect(**self.configurantion)
        self.cursor = self.conn.cursor()
        return self.cursor

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.conn.commit()
        self.cursor.close()
        self.conn.close()


class UsePostgreSQL(object):
    def __init__(self, config:dict):
        self.config = config

    def __enter__(self):
        self.conn = pg.connect(**self.config)
        self.cursor = self.conn.cursor()
        return self.cursor

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.conn.commit()
        self.cursor.close()
        self.conn.close()


class ExecutePostgreSQL(object):
    def __init__(self, kwargs:dict):
        self.cur = kwargs[&#39;cur&#39;]
        self.sql = kwargs[&#39;sql&#39;]
        self.argslist = kwargs[&#39;argslist&#39;]

    def pg_insert(self):
        # super(ExecutePostgreSQL, self).__enter__()
        try:
            log.logger.warning(f&#39;UsePostgreSQL.pg_insert Begin.&#39;)
            log.logger.info(f&#39;Total rows for current rollover: {len(self.argslist)}&#39;)
            execute_values(cur=self.cur, sql=self.sql, argslist=self.argslist)
            log.logger.warning(f&#39;UsePostgreSQL.pg_insert End.&#39;)
        except Exception as e:
            errlog.logger.error(f&#39;pg_insert: {e}&#39;)


# Demo
if __name__ == &#39;__main__&#39;:
    # MySQL cursor
    try:
        log.logger.warning(f&#39;MySQL Begin...&#39;)
        with UseMySQL(mysql_conn) as cursor:
            sql_1 = &quot;&quot;&quot;show tables&quot;&quot;&quot;
            sql_1 = &quot;&quot;&quot;select * from MURA.t_pm_alarm_tst&quot;&quot;&quot;
            cursor.execute(sql_1)
            data = cursor.fetchall()
            col0 = [x for x in data]    # [(),(),()]
            k = 0
            for rs in col0:
                k += 1
                print(f&#39;k:{k}   v:{rs}\nc1:{rs[0]} c2:{rs[1]} c3:{rs[2]} c4:{rs[3]} c5:{rs[4]} c6:{rs[5]} c7:{rs[6]}\n&#39;)

     except Exception as e:
        log.logger.error(f&#39;{e}\n&#39;)
        errlog.logger.error(f&#39;{e}&#39;)


    # PostgreSQL cursor
     try:
        log.logger.warning(f&#39;PostgreSQL Begin!!!&#39;)
        with UsePostgreSQL(pgsql_conn_pp) as cursor:
            sql_1 = &quot;&quot;&quot;SELECT * FROM public.t_fm_alarm_fields&quot;&quot;&quot;
            # sql_2 = &quot;&quot;&quot;SELECT COUNT(1) FROM public.t_fm_alarm_fields&quot;&quot;&quot;
            sql_3 = &quot;&quot;&quot;INSERT INTO public.t_fm_alarm_fields VALUES %s&quot;&quot;&quot;
            sql_4 = &quot;&quot;&quot;TRUNCATE TABLE public.t_fm_alarm_fields&quot;&quot;&quot;
            size = 100

            log.logger.info(f&#39;Current execution &lt;{sql_1}&gt;&#39;)
            cursor.execute(sql_1)

            rowcnt = cursor.rowcount
            log.logger.info(f&#39;Total rows for current execution &lt;{sql_1}&gt;: {rowcnt}&#39;)

            limitcnt, limitlast = divmod(rowcnt, size)
            log.logger.info(f&#39;Based on interval: {size}, total rows for rollover: {limitcnt}, ending number: {limitlast}&#39;)

            with UsePostgreSQL(pgsql_conn_prod) as cursor2_1:
                cursor2_1.execute(sql_4)  # 清理

            with UsePostgreSQL(pgsql_conn_prod) as cursor2_2:
                for rn in range(limitcnt + 1):
                    data = cursor.fetchmany(size=size)
                    exe_dict = {
                                    &quot;cur&quot;: cursor2_2,
                                    &quot;sql&quot;: sql_3,
                                    &quot;argslist&quot;: data
                    }
                    pg_prod = ExecutePostgreSQL(exe_dict)
                    pg_prod.pg_insert()

            with UsePostgreSQL(pgsql_conn_prod) as cursor3:
                cursor3.execute(sql_1)
                # result = cursor3.fetchall()
                log.logger.info(f&#39;Total rows for execution: {cursor3.rowcount}&#39;)

        log.logger.warning(f&#39;PostgreSQL End!!!&#39;)

    except Exception as e:
        log.logger.error(f&#39;{e}\n&#39;)
        errlog.logger.error(f&#39;{e}&#39;)</code></pre>
<hr>
<ul>
<li>logging_f.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/3/5 17:05
# @File: logging_f.py
# @Usage: 


import logging
from logging import handlers
import re


# Self Repo
from src.func_demo.func_f import *
# from func_demo.func_f import *


def re_match(list_input, re_pattern):
    &quot;&quot;&quot;
    :param list_input:  &lt;class: list&gt;
    :param re_pattern:  RE

    :return:    返回正则匹配结果集 re.compile(re_pattern).findall() &lt;class: list&gt;
    &quot;&quot;&quot;
    log.logger.info(f&#39;***RE***&#39;)
    try:
        p = re.compile(re_pattern)
        match_result = [rs for rs in list_input if p.findall(rs)]  # 别忘了，findall返回的是 &lt;class &#39;list&#39;&gt;
        # print(match_result)
        return match_result

    except Exception as e:
        print(&#39;Status: RE failed!&#39;)
        print(&#39;------------------&#39; * 2, f&#39;\nError Details:\n{e}&#39;)
        print(&#39;------------------&#39; * 2)
        return 1


class Logger(object):
    # 日志级别关系映射，这种定义类的变量x，并使用self.x运用于类方法内，还是第一次见    ---&gt;
    level_relations = {
        &#39;debug&#39;:logging.DEBUG,
        &#39;info&#39;:logging.INFO,
        &#39;warning&#39;:logging.WARNING,
        &#39;error&#39;:logging.ERROR,
        &#39;crit&#39;:logging.CRITICAL
    }

    def __init__(self, filename, level=&#39;warning&#39;, when=&#39;D&#39;, backup_count=7, interval=1,
                 fmt=&#39;%(asctime)s   %(pathname)s ---&gt; %(funcName)s ---&gt; %(threadName)s ---&gt; [line:%(lineno)d][%(levelname)s] ⬇⬇⬇\n&#39;
                     &#39;%(asctime)s   ⬆⬆⬆ [%(levelname)s]: %(message)s&#39;):

        # 1.最低级别logging对象设置
        self.logger = logging.getLogger(filename)
        self.format_str = logging.Formatter(fmt, datefmt=&#39;%Y-%m-%d %H:%M:%S&#39;) # 设置日志格式
        self.logger.setLevel(self.level_relations.get(level))   # 设置日志级别    &lt;---

        # 2.不同级别的Handler对象：sh &amp; th
        sh = logging.StreamHandler()  # 控制台流式输出
        sh.setFormatter(self.format_str)   # 设置屏幕上显示的格式
        # logging.handlers.RotatingFileHandler  # 按大小切分
        # logging.FileHandler # 文件输出

        # 指定间隔时间自动生成文件的对象处理器
        # 实例化TimedRotatingFileHandler
        th = handlers.TimedRotatingFileHandler(filename=filename,
                                               when=when,
                                               backupCount=backup_count,
                                               encoding=&#39;utf-8&#39;,
                                               interval=interval,
                                               delay=True
                                               )    # 往文件里写入
        # interval是时间间隔，backupCount是备份文件的个数，如果超过这个个数，就会自动删除，when是间隔的时间单位，单位有以下几种：
        # S/M/H/D/W/midnight
        th.setFormatter(self.format_str)    # 设置文件里写入的格式

        # 3.从对象处理器内添加
        self.logger.addHandler(sh) #把对象加到logger里
        self.logger.addHandler(th)
        # self.logger.removeHandler(sh)

    def err_log_test(self):
        print(1 + &#39;_2&#39;)


current_path = f&#39;./logs/&#39;
log = Logger(filename=current_path + f&#39;all_bokeh.log&#39;, level=&#39;info&#39;, when=&#39;H&#39;, fmt=&#39;%(asctime)s   [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)
errlog = Logger(filename=current_path + f&#39;err_bokeh.log&#39;, level=&#39;error&#39;, when=&#39;H&#39;, fmt=&#39;%(asctime)s   [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)</code></pre>
<hr>
<ul>
<li>func_f.py</li>
</ul>
<pre><code class="python">
# -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 19/9/5 8:08
# @File: func_f.py

import datetime
import os
import shutil
from sys import exc_info, path
from re import compile as re_compile
# from pprint import pprint


def date_f(daysdelta=0, hoursdelta=0):
    &quot;&quot;&quot;
    :param timedelta: Day Intervals
    :param hoursdelta: Hour Intervals
    :return: date &lt;class:tuple&gt;
            Ex: (&#39;20191205&#39;, &#39;2019120522&#39;, &#39;20191205 22:40:51&#39;,
                 {&#39;year&#39;: &#39;2019&#39;, &#39;month&#39;: &#39;12&#39;, &#39;day&#39;: &#39;05&#39;, &#39;hour&#39;: &#39;22&#39;}, &#39;src.func_demo.func_f&#39;)
    &quot;&quot;&quot;
    # date = []
    # date_str = datetime.datetime.now().strftime(&#39;%Y%m%d&#39;)

    date_str = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d&#39;)
    date_str_h = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d%H&#39;)
    date_str_s = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d %H:%M:%S&#39;)

    # 各维度时间戳段拆分
    year = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y&#39;)
    month = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%m&#39;)
    day = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%d&#39;)
    hour = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%H&#39;)
    date_dict = dict(year=year, month=month, day=day, hour=hour)

    # 所有已知时间格式组合
    date = (date_str, date_str_h, date_str_s, date_dict, __name__)
    return date</code></pre>
<hr>
<ul>
<li>kafka_conf.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/3/23 15:46
# @File: kafka_conf.py
# @Usage: cfg for kafka &amp; MySQL &amp; PostgreSQL


# Self Repo


# Kafka configuration
kafka_cfg_dict = {
    &#39;bootstrap_servers&#39;: &quot;192.168.73.10:9092&quot;,
    &#39;topic&#39;: &quot;test&quot;
}

# MySQL configuration
mysql_conn = {
    # oltp_mysql_matser = pymysql.connect(host=&#39;192.168.73.21&#39;, user=&#39;root&#39;, passwd=&#39;123456&#39;, db=&#39;MURA&#39;, port=3306)
    &quot;host&quot;: &#39;192.168.73.21&#39;,
    &quot;user&quot;: &quot;root&quot;,
    &quot;password&quot;: &#39;123456&#39;,
    &quot;database&quot;: &quot;MURA&quot;,
    &quot;port&quot;: 3306
}

# sqlmap for MySQL
sql_map = {
    &quot;sql1&quot;: &quot;select * from MURA.t_pm_alarm_tst&quot;,
    &quot;sql2&quot;: &quot;select count(1) from MURA.t_pm_alarm_tst&quot;,
}

# PostgreSQL configuration
pgsql_conn = {
    # oltp_mysql_matser = pymysql.connect(host=&#39;192.168.73.21&#39;, user=&#39;root&#39;, passwd=&#39;123456&#39;, db=&#39;MURA&#39;, port=3306)
    &quot;host&quot;: &#39;192.168.73.21&#39;,
    &quot;user&quot;: &quot;postgres&quot;,
    &quot;password&quot;: &#39;ghr921028&#39;,
    &quot;database&quot;: &quot;postgres&quot;,
    &quot;port&quot;: 5432
}

pgsql_conn_pp = {
    &quot;host&quot;: &#39;10.73.8.28&#39;,
    &quot;user&quot;: &quot;postgres&quot;,
    &quot;password&quot;: &#39;xxx&#39;,
    &quot;database&quot;: &quot;postgres&quot;,
    &quot;port&quot;: 5432
}

pgsql_conn_prod = {
    &quot;host&quot;: &#39;10.72.8.50&#39;,
    &quot;user&quot;: &quot;postgres&quot;,
    &quot;password&quot;: &#39;xxx&#39;,
    &quot;database&quot;: &quot;postgres&quot;,
    &quot;port&quot;: 5432
}


# MySQL table demo
drop table if exists MURA.t_pm_alarm_tst;
create table MURA.`t_pm_alarm_tst` (
  `res_type` int(11) not null,
  `res_key` varchar(20) default null,
  `kpi_id` BIGINT not null AUTO_INCREMENT,
  `time` date default null,
  `value` int(5) default null,
  `vendor` varchar(5) default null,
  `city` varchar(5) default null,
  primary key (`kpi_id`)
)AUTO_INCREMENT = 5000200010001 ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

# MySQL data insert
insert into MURA.t_pm_alarm_tst (res_type, res_key, time, value, vendor, city)
values(&#39;1&#39;, &#39;10001&#39;, now() + 0, &#39;60&#39;, &#39;华为&#39;, &#39;531&#39;),
(&#39;1&#39;, &#39;10001&#39;, now() + 0, &#39;60&#39;, &#39;华为&#39;, &#39;531&#39;),
(&#39;1&#39;, &#39;10001&#39;, now() + 0, &#39;61&#39;, &#39;诺基亚&#39;, &#39;531&#39;),
(&#39;2&#39;, &#39;10001&#39;, now() + 100000, &#39;62&#39;, &#39;华为&#39;, &#39;531&#39;)</code></pre>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Kafka%20Python3%20PG">Kafka Python3 PG</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "20200323_1205_Python3-Kafka-Producer&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>











</body>
</html>
