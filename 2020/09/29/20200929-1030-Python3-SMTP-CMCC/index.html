<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/shin.png">
  <link rel="icon" type="image/png" href="/img/shin.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="Shinnosuke Guo">
  <meta name="keywords" content="">
  <title>20200929_1030_Python3-SMTP-CMCC ~ Shinnosuke</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Shinnosuke</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/archive.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Tuesday, September 29th 2020, 10:35 am
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    1.1k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      5 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h2 id="Python3-SMTP"><a href="#Python3-SMTP" class="headerlink" title="Python3 SMTP"></a>Python3 SMTP</h2><h3 id="01-API"><a href="#01-API" class="headerlink" title="01. API"></a>01. API</h3><ul>
<li>Repo Point<br>  smtplib<br>  threading<br>  email.mime.base.MIMEBase<br>  email.mime.text.MIMEText<br>  email.header.Header<br>  email.utils.formataddr<br>  email.mime.multipart.MIMEMultipart</li>
</ul>
<h3 id="02-SMTP类"><a href="#02-SMTP类" class="headerlink" title="02. SMTP类"></a>02. SMTP类</h3><ul>
<li>class_mail_demo.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shinnosuke
# @Date: 20/7/17 10:58
# @File: class_mail_demo.py
# @Usage: class_mail_demo


# Self Repo 


# import sys
# import os
# import re
import smtplib
import threading
from email import encoders
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.header import Header
from email.utils import formataddr
from email.mime.multipart import MIMEMultipart
from time import time, ctime, sleep
# from tqdm import tqdm



# Self Repo
# CMD模式运行配置
# from func_test.func_f import date_f
# from func_test.logging_f import *
# from cfg import bas_mail_conf
# from cfg import sql_conf

# 非CMD模式运行配置
from src.func_demo.func_f import date_f
from src.func_demo.func_f import clog, errclog
from src.cfg.cfg_mail_app import mail_file_path, mail_file_pattern


def lock_f(lock_flag=&#39;N&#39;):
    def threading_f(f):
        def inner_f(*value, **kwargs):
            clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; begin!&#39;)
            if lock_flag == &#39;Y&#39;:
                # i += 1
                lock = threading.RLock()
                with lock:
                    # r_lock.acquire()
                    clog.logger.info(f&#39;Thread {threading.current_thread().getName()} is running. Time: {ctime()}&#39;)
                    dt_start = int(time())
                    f(*value, **kwargs)
                    # balance.append(result)
                    # r_lock.release()
                    clog.logger.info(f&#39;Thread {threading.current_thread().getName()} end. Time: {ctime()}&#39;)
                    clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; closed! time consume：{int(time()) - dt_start}s.&#39;)
            else:
                clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; skip, bye!&#39;)
                f(*value, **kwargs)
                # balance.append(result)
            # print(f&#39;balance: {balance}&#39;)    # 线程结果集合 &lt;class: list&gt;
            # return balance
        return inner_f
    return threading_f


class MailSender(object):
    def __init__(self):  # 邮件概览/正文/文件名(含路径)
        self.mail_attach = []
        self.msg = MIMEMultipart()  # 开辟一个带文件的mail对象

    def mail_mime_action(self, receivers, message_body, mail_server, sender, password, port, attach=None):
        # mail_server = &#39;smtp.qq.com&#39;
        subject = &#39;Py-%s &lt;中移智行告警服务&gt;&#39; % date_f(0)[0]

        # MIMEMultipart 形式构造邮件正文
        self.msg[&#39;From&#39;] = formataddr([&#39;中移智行网络服务&#39;, sender])
        self.msg[&#39;To&#39;] = formataddr([&#39;,&#39;.join(receivers), &#39;utf-8&#39;])  # 用&#39;,&#39;进行拼接，待拼接内容：join(x)内的x
        self.msg[&#39;Subject&#39;] = Header(subject, &#39;utf-8&#39;)

        # 正文loading
        clog.logger.info(&#39;Mail body loading...&#39;)
        self.msg.attach(MIMEText(message_body, &#39;plain&#39;, &#39;utf-8&#39;))
        # self.msg.attach(MIMEText(message + &#39;\n&#39; + title + message_str, &#39;plain&#39;, &#39;utf-8&#39;))

        # 邮件装载附件
        # 方法1
        attach_tmp = None
        if attach:
            try:
                clog.logger.info(&#39;Mail attachments loading...&#39;)
                # if isinstance(attach, list):
                #     clog.logger.info(&#39;Mail attachments list loading...&#39;)
                #     for fn in attach:
                #         attach_tmp = self.msg_attach(fn)
                #     self.msg.attach(attach_tmp)
                # else:
                attach_tmp = self.msg_attach(attach)
                self.msg.attach(attach_tmp)
                clog.logger.info(f&#39;Mail attachments loaded successfully: {attach}&#39;)
            except Exception as e:
                errclog.logger.error(f&#39;Failed to load attachments! {e}&#39;)

        try:
            if port == 25:
                # for _ in tqdm(range(30), ncols=80):
                #     sleep(1)
                with smtplib.SMTP(mail_server, port) as server:
                    clog.logger.info(server.sock)
                    server.login(sender, password)  # 括号中对应的是发件人邮箱账号、邮箱密码
                    server.sendmail(sender, receivers, self.msg.as_string())  # 括号中对应的是发件人邮箱账号、收件人邮箱账号、邮件内容发送
                    clog.logger.info(f&#39;Mail sended successfully.&#39;)
            else:
                with smtplib.SMTP_SSL(mail_server, port,) as server:   # 发件人邮箱中的SMTP服务器，SMTP: 25 SMTP_SSL: 465
                    clog.logger.info(server.sock)
                    server.login(sender, password)  # 括号中对应的是发件人邮箱账号、邮箱密码
                    server.sendmail(sender, receivers, self.msg.as_string())  # 括号中对应的是发件人邮箱账号、收件人邮箱账号、邮件内容发送
                    clog.logger.info(f&#39;Mail sended successfully.&#39;)
                # clog.logger.info(server.sock)
            # server.quit()  # 关闭连接
            # server.close()
        except Exception as e:
            errclog.logger.error(f&#39;{e}&#39;)

    def msg_attach(self, file_name):
        &quot;&quot;&quot;
        :param file_name: 待加载文件(绝对路径)
        :return:  type(attach): &lt;class &#39;email.mime.text.MIMEText&#39;&gt; 附件封装结果
        Ex:
            att1 = MIMEText(open(file_name, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
            att1[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
            att1[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name    # 这里的filename可任意，写什么名字，邮件中显示什么名字
            msg.attach(att1)

            att2 = MIMEText(open(file_name2, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
            att2[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
            att2[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name2    # 这里的filename可任意，写什么名字，邮件中显示什么名字
            msg.attach(att2)
        &quot;&quot;&quot;
        # attach = MIMEText(open(f&#39;./data_output/{file_name}&#39;, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
        # attach[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
        # attach[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name  # 这里的filename可任意，写什么名字，邮件中显示什么名字
        # clog.logger.info(f&#39;Mail message attach successfully.&#39;)

        with open(f&#39;./data_output/{file_name}&#39;, &#39;rb&#39;) as f:
            # 设置附件的MIME和文件名，这里是png类型:
            base = MIMEBase(&#39;csv&#39;, &#39;csv&#39;, filename=f&#39;{file_name}&#39;)
            # 加上必要的头信息:
            base.add_header(&#39;Content-Disposition&#39;, &#39;attachment&#39;, filename=f&#39;{file_name}&#39;)
            base.add_header(&#39;Content-ID&#39;, &#39;&lt;0&gt;&#39;)
            base.add_header(&#39;X-Attachment-Id&#39;, &#39;0&#39;)
            # 把附件的内容读进来:
            base.set_payload(f.read())
            # 用Base64编码:
            encoders.encode_base64(base)
            return base</code></pre>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/SMTP%20Python3%20PG">SMTP Python3 PG</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "20200929_1030_Python3-SMTP-CMCC&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>











</body>
</html>
