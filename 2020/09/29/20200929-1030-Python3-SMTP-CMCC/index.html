<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/shin.png">
  <link rel="icon" type="image/png" href="/img/shin.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="Shinnosuke Guo">
  <meta name="keywords" content="">
  <title>20200929_1030_Python3-SMTP-CMCC ~ Shinnosuke</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Shinnosuke</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/archive.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Tuesday, September 29th 2020, 10:35 am
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    5.6k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      32 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h2 id="Python3-SMTP"><a href="#Python3-SMTP" class="headerlink" title="Python3 SMTP"></a>Python3 SMTP</h2><h3 id="01-API"><a href="#01-API" class="headerlink" title="01. API"></a>01. API</h3><ul>
<li>Repo Point<br>  smtplib<br>  threading<br>  email.mime.base.MIMEBase<br>  email.mime.text.MIMEText<br>  email.header.Header<br>  email.utils.formataddr<br>  email.mime.multipart.MIMEMultipart</li>
</ul>
<h3 id="02-SMTP类"><a href="#02-SMTP类" class="headerlink" title="02. SMTP类"></a>02. SMTP类</h3><ul>
<li>class_mail_demo.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shinnosuke
# @Date: 20/7/17 10:58
# @File: class_mail_demo.py
# @Usage: class_mail_demo


# Self Repo 


# import sys
import os
import re
import smtplib
import threading
from email import encoders
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.header import Header
from email.utils import formataddr
from email.mime.multipart import MIMEMultipart
from time import time, ctime, sleep
# from tqdm import tqdm


# Self Repo
# CMD模式运行配置
# from func_test.func_f import date_f
# from func_test.logging_f import *
# from cfg import bas_mail_conf
# from cfg import sql_conf

# 非CMD模式运行配置
from src.func_demo.func_f import date_f
from src.func_demo.func_f import clog, errclog
from src.cfg.cfg_mail_app import mail_file_path, mail_file_pattern

# from func_demo.func_f import date_f
# from func_demo.func_f import clog, errclog
# from cfg.cfg_mail_app import mail_file_path, mail_file_pattern



def lock_f(lock_flag=&#39;N&#39;):
    def threading_f(f):
        def inner_f(*value, **kwargs):
            clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; begin!&#39;)
            if lock_flag == &#39;Y&#39;:
                # i += 1
                lock = threading.RLock()
                with lock:
                    # r_lock.acquire()
                    clog.logger.info(f&#39;Thread {threading.current_thread().getName()} is running. Time: {ctime()}&#39;)
                    dt_start = int(time())
                    f(*value, **kwargs)
                    # balance.append(result)
                    # r_lock.release()
                    clog.logger.info(f&#39;Thread {threading.current_thread().getName()} end. Time: {ctime()}&#39;)
                    clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; closed! time consume：{int(time()) - dt_start}s.\n&#39;)
            else:
                clog.logger.warning(f&#39;decorator job &lt;@lock_f&gt; skip, bye!&#39;)
                f(*value, **kwargs)
                # balance.append(result)
            # print(f&#39;balance: {balance}&#39;)    # 线程结果集合 &lt;class: list&gt;
            # return balance
        return inner_f
    return threading_f


class MailSender(object):
    def __init__(self):  # 邮件概览/正文/文件名(含路径)
        self.mail_attach = []
        self.msg = MIMEMultipart()  # 开辟一个带邮件的mail接口

    def mail_mime_action(self, receivers, message_body, mail_server, sender, password, port, attach=None):
        # mail_server = &#39;smtp.qq.com&#39;
        subject = &#39;Py-%s &lt;中移智行监控&gt;&#39; % date_f()[2]

        # MIMEMultipart 形式构造邮件正文
        # self.msg = MIMEMultipart()  # 开辟一个带邮件的mail接口
        self.msg[&#39;From&#39;] = formataddr([&#39;中移智行服务&#39;, sender])
        self.msg[&#39;To&#39;] = formataddr([&#39;,&#39;.join(receivers), &#39;utf-8&#39;])  # 用&#39;,&#39;进行拼接，待拼接内容：join(x)内的x
        self.msg[&#39;Subject&#39;] = Header(subject, &#39;utf-8&#39;)

        # 正文loading
        clog.logger.info(&#39;Mail body loading...&#39;)
        self.msg.attach(MIMEText(message_body, &#39;plain&#39;, &#39;utf-8&#39;))
        # self.msg.attach(MIMEText(message + &#39;\n&#39; + title + message_str, &#39;plain&#39;, &#39;utf-8&#39;))

        # 邮件装载附件
        # 方法1
        if attach:
            try:
                clog.logger.info(&#39;Mail attachments loading...&#39;)
                # for fn in attach:
                attach_tmp = self.msg_attach(attach)
                self.msg.attach(attach_tmp)
                clog.logger.info(f&#39;Mail attachments loaded successfully: {attach}&#39;)
            except Exception as e:
                errclog.logger.error(f&#39;Failed to load attachments! {e}&#39;)

        # 方法2
        # try:
        #     clog.logger.info(&#39;Mail attachments loading...&#39;)
        #     cur_list_re = []
        #     for fn in os.walk(mail_file_path):
        #         # print(f&#39;fn[-1]: {fn[-1]}&#39;)  # ./data_output/*
        #         for cur in fn[-1]:  # 开始正则筛选
        #             x = re.search(mail_file_pattern, cur)
        #             clog.logger.info(f&#39;current file: {cur}, file_pattern_result: {x}&#39;)
        #             # cur: 20191217_PKG.csv, x: None
        #             # cur: 20191218_GATHER.csv, x: &lt;re.Match object; span=(0, 19), match=&#39;20191218_GATHER.csv&#39;&gt;
        #             if x:
        #                 cur_list_re.append(mail_file_path.mail_file_path_class + x.group())
        #             else:
        #                 continue
        #     for rx in cur_list_re:
        #         # print(f&#39;rx: {rx}&#39;)
        #         tx_tmp = self.msg_attach(rx)
        #         self.msg.attach(tx_tmp)
        #     clog.logger.info(f&#39;Mail loaded successfully.&#39;)
        # except Exception as e:
        #     errclog.logger.error(f&#39;Failed to load mail! {e}&#39;)

        try:
            if port == 25:
                # for _ in tqdm(range(30), ncols=80):
                #     sleep(1)
                with smtplib.SMTP(mail_server, port, source_address=(&#39;10.72.8.25&#39;, 8119)) as server: # laddr=(&#39;117.135.142.216&#39;, 465), raddr=(&#39;xxx.xx.xx.xx&#39;, 465)
                    clog.logger.info(server.sock)
                    server.login(sender, password)  # 括号中对应的是发件人邮箱账号、邮箱密码
                    server.sendmail(sender, receivers, self.msg.as_string())  # 括号中对应的是发件人邮箱账号、收件人邮箱账号、邮件内容发送
                    clog.logger.info(f&#39;Mail sended successfully.&#39;)
            else:
                #for _ in tqdm(range(5), ncols=80):
                #    sleep(1) 
                with smtplib.SMTP_SSL(mail_server, port) as server: # laddr=(&#39;117.135.142.216&#39;, 465), raddr=(&#39;xxx.xx.xx.xx&#39;, 465)
                    clog.logger.info(server.sock)
                    # sleep(30)
                    server.login(sender, password)  # 括号中对应的是发件人邮箱账号、邮箱密码
                    server.sendmail(sender, receivers, self.msg.as_string())  # 括号中对应的是发件人邮箱账号、收件人邮箱账号、邮件内容发送
                    clog.logger.info(f&#39;Mail sended successfully.&#39;)
                # clog.logger.info(server.sock)
        except Exception as e:
            # import json
            errclog.logger.error(f&#39;{e}&#39;)

    def msg_attach(self, file_name):
        &quot;&quot;&quot;
        :param file_name: 待加载文件(绝对路径)
        :return:  type(attach): &lt;class &#39;email.mime.text.MIMEText&#39;&gt; 附件封装结果
        Ex:
            att1 = MIMEText(open(file_name, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
            att1[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
            att1[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name    # 这里的filename可任意，写什么名字，邮件中显示什么名字
            msg.attach(att1)

            att2 = MIMEText(open(file_name2, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
            att2[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
            att2[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name2    # 这里的filename可任意，写什么名字，邮件中显示什么名字
            msg.attach(att2)
        &quot;&quot;&quot;
        # attach = MIMEText(open(f&#39;./data_output/{file_name}&#39;, &#39;rb&#39;).read(), &#39;base64&#39;, &#39;utf-8&#39;)
        # attach[&quot;Content-Type&quot;] = &#39;application/octet-stream&#39;
        # attach[&quot;Content-Disposition&quot;] = &#39;attachment; filename=&#39; + file_name  # 这里的filename可任意，写什么名字，邮件中显示什么名字
        # clog.logger.info(f&#39;Mail message attach successfully.&#39;)
        with open(f&#39;./data_output/{file_name}&#39;, &#39;rb&#39;) as f:
            # 设置附件的MIME和文件名，这里是png类型:
            base = MIMEBase(&#39;csv&#39;, &#39;csv&#39;, filename=f&#39;{file_name}&#39;)
            # 加上必要的头信息:
            base.add_header(&#39;Content-Disposition&#39;, &#39;attachment&#39;, filename=f&#39;{file_name}&#39;)
            base.add_header(&#39;Content-ID&#39;, &#39;&lt;0&gt;&#39;)
            base.add_header(&#39;X-Attachment-Id&#39;, &#39;0&#39;)
            # 把附件的内容读进来:
            base.set_payload(f.read())
            # 用Base64编码:
            encoders.encode_base64(base)
            return base
</code></pre>
<ul>
<li>class_DB_demo.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/3/29 12:19
# @File: class_DB_demo.py
# @Usage: 


# import pymysql as pm
import psycopg2 as pg
from psycopg2.extras import execute_values as pgev
from threading import Thread

# Self Repo
# from func_demo.func_f import clog, errclog
from src.func_demo.func_f import clog, errclog


class UseMySQL(object):
    def __init__(self, config:dict):
        self.configurantion = config

    def __enter__(self):
        self.conn = pm.connect(**self.configurantion)
        self.cursor = self.conn.cursor()
        return self.cursor

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.conn.commit()
        self.cursor.close()
        self.conn.close()


class UsePostgreSQL(object):
    def __init__(self, config:dict):
        self.config = config

    def __enter__(self):
        self.conn = pg.connect(**self.config)
        self.cursor = self.conn.cursor()
        return self.cursor

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.conn.commit()
        self.cursor.close()
        self.conn.close()


class ExecutePostgreSQL(object):
    def __init__(self, kwargs:dict):
        self.cur = kwargs[&#39;cur&#39;]
        self.sql = kwargs[&#39;sql&#39;]
        self.argslist = kwargs[&#39;argslist&#39;]

    def pg_insert(self):
        # super(ExecutePostgreSQL, self).__enter__()
        try:
            clog.logger.warning(f&#39;UsePostgreSQL.pg_insert Begin.&#39;)
            clog.logger.info(f&#39;Total rows for current rollover: {len(self.argslist)}&#39;)
            pgev(cur=self.cur, sql=self.sql, argslist=self.argslist)
            clog.logger.warning(f&#39;UsePostgreSQL.pg_insert End.&#39;)
        except (Exception, pg.DatabaseError) as e:
            errclog.logger.error(f&#39;pg_insert: {e}&#39;)


class MyThread(Thread):
    def __init__(self, func=None, args=()):
        super().__init__()
        self.func = func
        self.args = args
        self.result = []

    def run(self):
        self.result = self.func(*self.args)

    def get_result(self):
        &quot;&quot;&quot;
        :return:        0: thread result
                        1: exception
        &quot;&quot;&quot;
        try:
            return self.result
        except Exception as e:
            errclog.looger.error(f&#39;{e}&#39;)
            return 1
</code></pre>
<ul>
<li>mail_app_main.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shinnosuke
# @Date: 20/8/21 10:44
# @File: mail_app_main.py
# @Usage: mail_app_main


import pandas as pd
# import numpy as np
# from time import ctime

# Self Repo
# CMD模式运行配置
# from func_demo.class_mail_demo import *
# from func_demo.class_DB_demo import *
# from func_demo.func_f import date_f
# from cfg.cfg_mail_app import receivers, sender, pgsql_conn_prod, rename_dict, mail_file_path, SQL, DIM
# from cfg.cfg_mail_app import PACKED_THRESHOLD, SPLIT_PARA, MAIL_BITE_LIMIT



# 非CMD模式运行配置
from src.func_demo.class_mail_demo import *
from src.func_demo.class_DB_demo import *
from src.func_demo.func_f import date_f
from src.cfg.cfg_mail_app import receivers, sender, pgsql_conn_prod, rename_dict, mail_file_path, SQL, DIM
from src.cfg.cfg_mail_app import PACKED_THRESHOLD, SPLIT_PARA, MAIL_BITE_LIMIT


pd_df = lambda x: pd.DataFrame(x)
pd.set_option(&#39;display.max_columns&#39;, None, &#39;display.max_rows&#39;, None, &#39;display.max_colwidth&#39;, 100, &#39;display.width&#39;, 1000)
f = &#39;-&#39;*80
f2 = &#39;*&#39;*80


def email_decorator(email_flag=&#39;N&#39;):
    def mail_post_f(f):
        def inner_f(*value, **kwargs):
            clog.logger.warning(f&#39;decorator job &lt;@email_f&gt; begin!&#39;)
            if email_flag == &#39;Y&#39;:
                clog.logger.info(f&#39;Thread {threading.current_thread().getName()} is running. Time: {ctime()}&#39;)
                # step1
                results = f(*value, **kwargs)

                # step2 message formatting
                # do something...
                if results:
                    body = f&#39;{f2}\n{results[0]}{f2}&#39;
                    recv = results[1]
                    # del results
                    clog.logger.info(f&#39;\n{body}&#39;)
                    clog.logger.info(f&#39;receiver: {recv}&#39;)
                    clog.logger.info(f&#39;user: {sender[&quot;user&quot;]}&#39;)

                    # step4 load/send
                    if len(results) &gt; 2:  # if attach existed
                        attach = results[2]
                        clog.logger.info(f&#39;~~~Mail attachments {attach}~~~&#39;)
                        # print(attach)

                        if isinstance(attach, list):
                            for fn in attach:
                                mail = MailSender()
                                mail.mail_mime_action(recv, body, mail_server=sender[&quot;mail_server&quot;], sender=sender[&quot;user&quot;], password=sender[&quot;password&quot;], port=sender[&quot;port&quot;], attach=f&#39;{fn}&#39;)
                        else:
                            mail = MailSender()
                            mail.mail_mime_action(recv, body, mail_server=sender[&quot;mail_server&quot;], sender=sender[&quot;user&quot;], password=sender[&quot;password&quot;], port=sender[&quot;port&quot;], attach=f&#39;{attach}&#39;)
                    else:
                        mail = MailSender()
                        mail.mail_mime_action(recv, body, mail_server=sender[&quot;mail_server&quot;], sender=sender[&quot;user&quot;], password=sender[&quot;password&quot;], port=sender[&quot;port&quot;],)

                    clog.logger.info(f&#39;Thread {threading.current_thread().getName()} end. Time: {ctime()}&#39;)
                    clog.logger.warning(f&#39;decorator job &lt;@email_f&gt; closed!\n&#39;)
            else:
                clog.logger.warning(f&#39;decorator job &lt;@email_f&gt; skip!&#39;)
                results = f(*value, **kwargs)
                if results:
                    body = f&#39;{f2}\n{results[0]}{f2}&#39;
                    del results
                    clog.logger.info(f&#39;message body:\n{body}&#39;)
                    # clog.logger.info(f&#39;receiver: {recv}&#39;)
                    # clog.logger.info(f&#39;user: {sender[&quot;user&quot;]}&#39;)
                clog.logger.warning(&#39;~~~hahaha decorator job &lt;@email_f&gt; closed!\n&#39;)
                # return results
        return inner_f
    return mail_post_f


@email_decorator(&#39;Y&#39;)
def email_split(SQL, k, v):
    &quot;&quot;&quot;
    :param receiver:   &lt;class: dict&gt;
                        Ex:
                            recv = {
                                &quot;province&quot;: {
                                    &quot;四川省&quot;: &quot;717648387@qq.com&quot;,  # 对应省份接口人
                                    &quot;上海市&quot;: &quot;717648387@qq.com&quot;,
                                },
                                &quot;city&quot;: {
                                &quot;甘孜藏族自治州&quot;: &quot;717648387@qq.com&quot;,  # 对应地市接口人
                                &quot;阿里地区&quot;: &quot;717648387@qq.com&quot;
                                }
                            }
    :return: message, v     &lt;class: tuple(str, str)&gt;
    &quot;&quot;&quot;
    try:
        message = &#39;&#39;
        message_offline = &#39;&#39;
        with UsePostgreSQL(pgsql_conn_prod) as cursor:
            cursor.execute(SQL, )   # execution
            rowcnt = cursor.rowcount
            clog.logger.info(f&#39;cnt for current execution：{rowcnt}&#39;)
            res = cursor.fetchall()     # fetch
            if not rowcnt:     # None =&gt; pass
                clog.logger.warning(f&#39;cnt for current province &lt;{k}&gt; is null, job pass&#39;)
                message = f&#39;当前省份&lt;{k}&gt;，当前时刻无告警，请知晓.\n&#39;
                return message, v
            elif rowcnt &gt;= PACKED_THRESHOLD:       # packing + mail body
                clog.logger.warning(&#39;~~~dark time~~~&#39;)
                clog.logger.warning(f&#39;cnt for current province &lt;{k}&gt; is more than PACKED_THRESHOLD {PACKED_THRESHOLD}, results packing.&#39;)
                df = pd_df(res)
                df_columns = [rk for rk in rename_dict.keys()]
                df.columns = df_columns                     # 为了重命名，先给编号
                # del df_columns
                if rowcnt &gt; MAIL_BITE_LIMIT:                            # 受客户邮箱限制，40条以上发送会失败，故超过拆分发送
                    message = f&#39;当前时刻告警量大于{MAIL_BITE_LIMIT}条, 邮件内容已拆分，请留意多封接收，详情请见附件.\n&#39;
                    quotient, remainder = divmod(rowcnt, SPLIT_PARA)    # 按照切分阈值，进行邮件切割:    107 = 3*30 + 17
                    # print(quotient, remainder)
                    # 当前时刻告警数量: 107, 切分参数: 30, 发送合计: 4, 最后一封邮件含告警: 17.
                    clog.logger.warning(f&#39;当前时刻告警数量: {rowcnt}, 切片参数: {SPLIT_PARA}, 发送合计: {quotient + 1}, 最后一封邮件含告警: {remainder}.&#39;)
                    index_begin = 0
                    index_end = 0
                    mail_attach_name_list = []
                    for rs in range(1, quotient + 1):
                        if rs == 1:
                            index_begin = 0
                            index_end = 0 + SPLIT_PARA
                        elif rs == quotient:
                            index_begin += SPLIT_PARA
                            index_end = rowcnt
                        else:
                            index_begin += SPLIT_PARA
                            index_end += SPLIT_PARA
                        clog.logger.info(f&#39;current index distribution: {index_begin} ~ {index_end}&#39;)
                        df_tmp = df.iloc[index_begin:index_end]
                        df_tmp.columns = df_columns                     # 为了重命名，先给编号
                        mail_attach_name = f&#39;{date_f()[2]}_alarm_service_{k}_{index_begin}_{index_end}.csv&#39;
                        df_tmp.rename(columns=rename_dict, inplace=True)
                        # df_tmp.to_csv(path_or_buf=f&#39;./data_output/{index_begin}_{index_end}.csv&#39;, header=True, mode=&#39;w&#39;, index=False, encoding=&#39;utf_8_sig&#39;)
                        df_tmp.to_csv(path_or_buf=f&#39;{mail_file_path}{mail_attach_name}&#39;, header=True, mode=&#39;w&#39;, index=False, encoding=&#39;utf_8_sig&#39;)
                        clog.logger.info(f&#39;generated file path: {mail_file_path}{mail_attach_name}&#39;)
                        mail_attach_name_list.append(mail_attach_name)
                    # print(mail_attach_name_list)
                    return message, v, mail_attach_name_list            # 告警量最高的，以多邮件单附件方式送出
                else:
                    message = f&#39;当前时刻告警量大于{PACKED_THRESHOLD}条, 详情请见附件.\n&#39;
                    mail_attach_name = f&#39;{date_f()[2]}_alarm_service_{k}.csv&#39;
                    df.rename(columns=rename_dict, inplace=True)
                    df.to_csv(path_or_buf=f&#39;{mail_file_path}{mail_attach_name}&#39;, header=True, mode=&#39;w&#39;, index=False, encoding=&#39;utf_8_sig&#39;)
                    clog.logger.info(f&#39;generated file path: {mail_file_path}{mail_attach_name}&#39;)
                    return message, v, mail_attach_name                 # 告警量次高的，以单邮件单附件方式送出
            else:                                           # no packing + mail body
                clog.logger.warning(&#39;~~~good time~~~&#39;)
                string = &#39;&#39;
                # message = &#39;&#39;
                # message_offline = &#39;&#39;
                flag_6 = 0
                # print(f&#39;res: {res}&#39;)  # test
                for rs in res:
                    num = 0
                    tmp = list(rs)
                    for rx in tmp:
                        if num == 0:
                            string = f&#39;{rx}&#39;
                        elif num == 1:
                            string = f&#39;{string}: {rx}&#39;
                        else:
                            string = f&#39;{string}-{rx}&#39;
                            if rx == &#39;006&#39;:  # offline alarm label determination
                                flag_6 = 1
                        num += 1
                    # save separately
                    if flag_6 == 1:
                        message_offline = f&#39;{string}\n{message_offline}&#39;    # message for offline
                    else:
                        message = f&#39;{string}\n{message}&#39;        # message for fault
                    flag_6 = 0
                if message_offline and message:
                    message = f&#39;{message_offline}{f}\n{message}&#39;
                elif message_offline and not message:
                    message = f&#39;{message_offline}&#39;
                else:
                   pass
                # print(f&#39;message final: {message}&#39;)
            return message, v
            # clog.logger.info(f&#39;\n{f2}\n{message}{f2}&#39;)
    except Exception as e:
        errclog.logger.error(e)


@lock_f(&#39;Y&#39;)
def mail_job(recv, dim=1):
    &quot;&quot;&quot;
    :param recv:   &lt;class: dict&gt;
    :param dim:   &lt;class: int&gt;
                        2: vendor
                        1: province
                        0: city
    :return:
    &quot;&quot;&quot;

    try:
        if dim == 1:     # province dimension
            if not recv[&quot;province&quot;]:   # None
                clog.logger.error(f&#39;province configuration for receiver is null, please check!!!&#39;)
                errclog.logger.error(f&#39;province configuration for receiver is null, please check!!!&#39;)
            else:
                cur_recv = recv[&quot;province&quot;]
                for k, v in cur_recv.items():   # city: address
                    # clog.logger.info(f&#39;\n{f}&#39;)
                    clog.logger.warning(&#39;~~~hahaha SMTP~~~&#39;)
                    clog.logger.info(f&#39;current province: {k}, mail_address: {v}&#39;)
                    k1 = &#39;\&#39;&#39; + k + &#39;\&#39;&#39;    # city: 上海市 -&gt; &#39;上海市&#39;
                    _SQL = SQL%(&#39;province&#39;, k1)     # SELECT * FROM v_alarm_all WHERE province = &#39;上海市&#39;
                    email_split(SQL=_SQL, k=k, v=v)
        elif dim == 2:
            pass
            if not recv[&quot;vendor&quot;]:   # None
                clog.logger.error(f&#39;vendor configuration for receiver is null, please check!!!&#39;)
                errclog.logger.error(f&#39;vendor configuration for receiver is null, please check!!!&#39;)
            else:
                cur_recv = recv[&quot;vendor&quot;]
                for k, v in cur_recv.items():   # city: address
                    # clog.logger.info(f&#39;\n{f}&#39;)
                    clog.logger.warning(&#39;~~~hahaha SMTP~~~&#39;)
                    clog.logger.info(f&#39;current vendor: {k}, mail_address: {v}&#39;)
                    k1 = &#39;\&#39;&#39; + k + &#39;\&#39;&#39;
                    _SQL = SQL%(&#39;vendor&#39;, k1)     # SELECT * FROM v_alarm_all WHERE vendor = &#39;中海达&#39;
                    email_split(SQL=_SQL, k=k, v=v)
        else:       # city dimension
            if not recv[&quot;city&quot;]:       # None
                clog.logger.error(f&#39;city configuration for receiver is null, please check!!!&#39;)
                errclog.logger.error(f&#39;city configuration for receiver is null, please check!!!&#39;)
            else:
                cur_recv = recv[&quot;city&quot;]
                for k, v in cur_recv.items():   # city: address
                    # clog.logger.info(f&#39;\n{f}&#39;)
                    clog.logger.warning(&#39;~~~hahaha SMTP~~~&#39;)
                    clog.logger.info(f&#39;current city: {k}, mail_address: {v}&#39;)
                    k1 = &#39;\&#39;&#39; + k + &#39;\&#39;&#39;    # city: 上海市 -&gt; &#39;上海市&#39;
                    _SQL = SQL%(&#39;city&#39;, k1)     # SELECT * FROM v_alarm_all WHERE city = &#39;上海市&#39;
                    email_split(SQL=_SQL, k=k, v=v)
    except Exception as e:
        errclog.logger.error(f&#39;{e}&#39;)


if __name__ == &#39;__main__&#39;:
    mail_job(recv=receivers, dim=DIM)
    # mail_job(recv=receivers, dim=2)
</code></pre>
<ul>
<li>cfg_mail_app.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shinnosuke
# @Date: 20/7/17 10:54
# @File: cfg_mail_app.py
# @Usage: cfg_main_app


# Self Repo 
from src.func_demo.func_f import date_f
# from src.func_demo.func_f import date_f

# dt
dt = date_f()[4]
y = date_f()[4][&quot;year&quot;]
m = date_f()[4][&quot;month&quot;]
d = date_f()[4][&quot;day&quot;]
h = date_f()[4][&quot;hour&quot;]
mi = date_f()[4][&quot;minute&quot;]

# title rename
rename_dict = {
    &quot;0&quot;: &quot;hap_code&quot;,
    &quot;1&quot;: &quot;dt&quot;,
    &quot;2&quot;: &quot;vendor&quot;,
    &quot;3&quot;: &quot;province&quot;,
    &quot;4&quot;: &quot;city&quot;,
    &quot;5&quot;: &quot;alarm_id&quot;,
    &quot;6&quot;: &quot;alarm_title&quot;
}

# packed threshold
PACKED_THRESHOLD = 20
# parameter for split, the size of each slice
SPLIT_PARA = 20
# bite limit due to the CMCC mail limitations, which should greater than packed threshold
MAIL_BITE_LIMIT = 40

# parse path
mail_file_path = r&#39;./data_output/&#39;

# Re
# mail_file_pattern = rf&#39;.*{y}{m}{d}_{h}{mi}.*?.csv$&#39;
mail_file_pattern = f&#39;{date_f()[2]}_alarm_service_.*?.csv&#39;

# choose dim
DIM = 1

# receivers
# receivers_demo = [&quot;717648387@qq.com&quot;, &quot;###@cmsr.chinamobile.com&quot;]  #, &quot;###@cmsr.chinamobile.com&quot;]
receivers_default = [&quot;###@cmsr.chinamobile.com&quot;]
receivers = {
    &quot;province&quot;: {
        # &quot;海南省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;福建省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],          # 1
        # &quot;黑龙江省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;广西壮族自治区&quot;: [&quot;###@cmsr.chinamobile.com&quot;],     # 2
        &quot;浙江省&quot;: [&quot;717648387@qq.com&quot;],
        &quot;上海市&quot;: [&quot;717648387@qq.com&quot;],       # 3
        &quot;河北省&quot;: [&quot;717648387@qq.com&quot;],
        &quot;辽宁省&quot;: [&quot;717648387@qq.com&quot;],        # 4
        # &quot;江西省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;吉林省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],          # 5
        # &quot;广东省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;湖南省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],           # 6
        # &quot;云南省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;贵州省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],          # 7
        # &quot;青海省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;重庆市&quot;: [&quot;###@cmsr.chinamobile.com&quot;],         # 8
        # &quot;四川省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;河南省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],            # 9
        # &quot;陕西省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;安徽省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],       # 10
        # &quot;山西省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;甘肃省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],             # 11
        # &quot;宁夏回族自治区&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;西藏自治区&quot;: [&quot;###@qq.com&quot;],        # 12
        # &quot;新疆维吾尔自治区&quot;: [&quot;###@cmsr.chinamobile.com&quot;],   # 13
        # &quot;江苏省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],          # 14
        # &quot;湖北省&quot;: [&quot;###@cmsr.chinamobile.com&quot;],        # 15
        # &quot;北京市&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;天津市&quot;: [&quot;###@cmsr.chinamobile.com&quot;],
        # &quot;内蒙古自治区&quot;: [&quot;###@cmsr.chinamobile.com&quot;],     # 16
        &quot;山东省&quot;: [&quot;717648387@qq.com&quot;],           # 17
    },
    &quot;city&quot;: {
        &quot;乐山市&quot;: [&quot;###@qq.com&quot;],                  # 地市维度
        &quot;凉山彝族自治州&quot;: [&quot;###@qq.com&quot;],
        &quot;上饶市&quot;: [&quot;###@qq.com&quot;],
    },
    &quot;vendor&quot;: {
        &quot;司南&quot;: [&quot;###@163.com&quot;],
        &quot;和芯&quot;: [&quot;###@unicorecomm.com&quot;],
        &quot;中海达&quot;: [&quot;###@outlook.com&quot;],  # 厂家维度
        &quot;南方测绘&quot;: &quot;###southgnss.com&quot;],
    }
}

# default append
for v1 in receivers.values():
    for v2 in v1.values():
        if isinstance(v2, list):
            if isinstance(receivers_default, str):
                v2.append(receivers_default)
            elif isinstance(receivers_default, list):
                for rs in receivers_default:
                    v2.append(rs)

sender = {
    &quot;user&quot;: &quot;####@###.com&quot;,
    &quot;password&quot;: &#39;####&#39;,
    &quot;mail_server&quot;: &quot;smtp.qq.com&quot;,
    &quot;port&quot;: 465
}

pgsql_conn_prod = {
    &quot;host&quot;: &#39;10.72.8.50&#39;,
    &quot;user&quot;: &quot;postgres&quot;,
    &quot;password&quot;: &#39;####&#39;,
    &quot;database&quot;: &quot;postgres&quot;,
    &quot;port&quot;: 5432,
}

# SQL
SQL = f&quot;&quot;&quot;SELECT * FROM v_alarm_all WHERE %s = %s &quot;&quot;&quot;
</code></pre>
<ul>
<li>func_f.py</li>
</ul>
<pre><code class="python"># -*- coding:utf-8 -*-
# @Author: Shin
# @Date: 20/7/23 15:19
# @File: func_f.py


import datetime
import os
import re
import shutil
import logging
from logging import handlers
from sys import exc_info
# from time import sleep


# Self Repo


def date_f(daysdelta=0, hoursdelta=0):
    &quot;&quot;&quot;
    :param timedelta: Day Intervals
    :param hoursdelta: Hour Intervals
    :return: date &lt;class:tuple&gt;
            Ex: (&#39;20191205&#39;, &#39;2019120522&#39;, &#39;20191205 22:40:51&#39;,
                 {&#39;year&#39;: &#39;2019&#39;, &#39;month&#39;: &#39;12&#39;, &#39;day&#39;: &#39;05&#39;, &#39;hour&#39;: &#39;22&#39;}, &#39;src.func_demo.func_f&#39;)
    &quot;&quot;&quot;
    date_str = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d&#39;)
    date_str_h = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d%H&#39;)
    date_str_mi = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d_%H%M&#39;)
    date_str_s = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y%m%d %H:%M:%S&#39;)

    # 各维度时间戳段拆分
    year = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%Y&#39;)
    month = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%m&#39;)
    day = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%d&#39;)
    hour = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%H&#39;)
    minute = (datetime.datetime.now() + datetime.timedelta(days=daysdelta, hours=hoursdelta)).strftime(&#39;%M&#39;)
    date_dict = dict(year=year, month=month, day=day, hour=hour, minute=minute)

    # 所有已知时间格式组合
    date = (date_str, date_str_h, date_str_mi, date_str_s, date_dict, __name__)
    return date


def callback(funcname, *args, **kwargs):
    &quot;&quot;&quot;
    :param funcname:    name for function
    :param args:
    :param kwargs:
    :return:            None: judgement for function operation results
    &quot;&quot;&quot;
    try:
        result = funcname(*args, **kwargs)
        if not result:
            selflog.logger.info(f&#39;Execute successfully: &lt;{funcname.__name__}&gt;&#39;)
        else:
            selflog.logger.info(f&#39;Callback: &lt;{funcname.__name__}&gt; return {result}.\n&#39;)
            return result
    except Exception as e:
        errselflog.logger.error(f&#39;{e}\n&#39;)


def file_mkdir(path, dir):
    &quot;&quot;&quot;
    :param path:    Target file path    Ex: r&#39;D:\Hadoop\PyFloder\bokeh_test\src\data&#39;
    :param dir:     Target dir name     Ex: 20200412
    :return:        0: regular
                    1: exception
                    2: redundant
    &quot;&quot;&quot;
    try:
        for rw in os.walk(path):
            for rs in rw:
                if len(rs) &gt; 0 and rs == rw[1]:  # 跳过文件夹名列表，os.walk会直接遍历所有子文件夹
                    try:
                        if dir not in rw[1]:
                            clog.logger.info(f&#39;Directory {dir} not existed, generated.&#39;)
                            os.chdir(path)
                            os.mkdir(dir)
                            return 0
                        else:
                            clog.logger.info(f&#39;Directory already existed: {path}/{dir}&#39;)
                            return 2
                    except FileExistsError as e:
                        clog.logger.error(f&#39;Directory generated error: {e}&#39;)
                        errclog.logger.error(f&#39;Directory generated error: {e}&#39;)
                        continue
                else:
                    continue
    except Exception as e:
        errclog.logger.error(f&#39;{e}&#39;)
        return 1


def file_rm_dir(path, pattern):
    &quot;&quot;&quot;
    :param path:        path contained the directory needed to be droped.
    :param pattern:     pattern expression
    :return:            0: regular
                        1: exception
    &quot;&quot;&quot;
    # try:
    #     for rw in os.walk(path):
    #         for rs in rw:
    #             if len(rs) &lt; 1:
    #                 continue
    #             elif isinstance(rs, str):
    #                 # clog.logger.info(f&#39;Current path: {rs}&#39;)
    #                 p = re.compile(pattern=pattern)
    #                 match_result = &#39;&#39;.join(p.findall(rs))   # &lt;class &#39;list&#39;&gt; ---&gt; &lt;class &#39;str&#39;&gt;
    #                 if match_result:
    #                     # os.chdir(path)
    #                     shutil.rmtree(match_result)
    #                     clog.logger.info(f&#39;Path dropped: {match_result}&#39;)
    #             elif isinstance(rs, list):
    #                 pass
    #
    # except Exception as e:
    #     errlog.logger.error(f&#39;{e}&#39;)
    try:
        for rs, _, _ in os.walk(path):
            p = re.compile(pattern=pattern)
            match_result = &#39;&#39;.join(p.findall(rs))   # &lt;class &#39;list&#39;&gt; ---&gt; &lt;class &#39;str&#39;&gt;
            if match_result:
                shutil.rmtree(match_result)
                clog.logger.info(f&#39;Path has been dropped: {match_result}&#39;)
            else:
                clog.logger.info(f&#39;Targer path not existed in {rs}&#39;)
        return 0
    except Exception as e:
        errclog.logger.error(f&#39;{e}&#39;)
        return 1


def file_rm_file(path, pattern):
    &quot;&quot;&quot;
    :param path:        path contained the files needed to be droped.
    :param pattern:     pattern expression
    :return:            match_result &lt;class list&gt;: regular
                        1: no match
                        2: exception
    &quot;&quot;&quot;
    try:
        match_result = []
        for _, _, file in os.walk(path):
            for rs in file:
                p = re.compile(pattern=pattern)
                # print(rs, p.findall(rs))
                result = p.findall(rs)  # class list
                if result:
                    # print(f&quot;{path}/{&#39;&#39;.join(result)}&quot;)
                    match_result.append(f&quot;{path}/{&#39;&#39;.join(result)}&quot;)
                else:
                    continue
                    # del result
            # print(match_result)
            if match_result:
                for rm in match_result:
                    selflog.logger.info(f&#39;{rm}&#39;)
                    os.remove(rm)
                # clog.logger.info(f&#39;Match results droped: {match_result}&#39;)
                return 0
            else:
                selflog.logger.info(f&#39;Nothing matched.&#39;)
                return 1
    except Exception as e:
        errselflog.logger.error(f&#39;{e}&#39;)
        return 2


def file_copy(src, dst, flag):
    &quot;&quot;&quot;
    :param src:         src(including file name)
    :param dst:         destination(path name)
    :param flag:        f: file
                        d: directory
    :return:            0: regular
                        1: I/O error
                        2: exception
    &quot;&quot;&quot;
    try:
        if flag == &#39;f&#39;: # file type
            shutil.copy(src, dst)
            clog.logger.info(f&#39;File copy done. {src} -&gt; {dst}&#39;)
            return 0
        else:   # path type
            shutil.copytree(src, dst)
            clog.logger.info(f&#39;Path copy done. {src} -&gt; {dst}&#39;)
    except IOError as e:
        errclog.logger.info(f&#39;Unable to copy file. {e}&#39;)   # print(&#39;Unable to copy file. %s&#39; % e)
        return 1
    except:
        errclog.logger.error(f&#39;Unexpected errors. {exc_info()}&#39;)
        return 2


def re_match(list_input, re_pattern):
    &quot;&quot;&quot;
    :param list_input:  &lt;class: list&gt;
    :param re_pattern:  RE
    :return:            返回正则匹配结果集 re.compile(re_pattern).findall() &lt;class: list&gt;
                        1: exception
    &quot;&quot;&quot;
    clog.logger.info(f&#39;***RE***&#39;)
    try:
        p = re.compile(re_pattern)
        match_result = [rs for rs in list_input if p.findall(rs)]  # 别忘了，findall返回的是 &lt;class &#39;list&#39;&gt;
        clog.logger.info(f&#39;{match_result}&#39;)
        return match_result

    except Exception as e:
        errclog.logger.error(f&#39;{e}&#39;)
        return 1


class Logger(object):
    # 日志级别关系映射，这种定义类的变量x，并使用self.x运用于类方法内，还是第一次见    ---&gt;
    level_relations = {
        &#39;debug&#39;: logging.DEBUG,
        &#39;info&#39;: logging.INFO,
        &#39;warning&#39;: logging.WARNING,
        &#39;error&#39;: logging.ERROR,
        &#39;critical&#39;: logging.CRITICAL
    }

    def __init__(self, filename, level=&#39;warning&#39;, when=&#39;D&#39;, backup_count=7, interval=1,
                 fmt=&#39;%(asctime)s %(module)s.%(funcName)s -&gt; %(threadName)s -&gt; [line:%(lineno)d][%(levelname)s] ⬇⬇⬇\n&#39;
                     &#39;%(asctime)s ⬆⬆⬆ [%(levelname)s]: %(message)s&#39;):
        &quot;&quot;&quot;
        :param filename:        log file name with absolute path
        :param level:           log level:  debug/info/warning/error/critical
        :param when:            interval unit:
                                S - Seconds
                                M - Minutes
                                H - Hours
                                D - Days
                                midnight - roll over at midnight
                                W{0-6} - roll over on a certain day; 0 - Monday
        :param backup_count:    interval backup num
        :param interval:        interval value with @param when
        :param fmt:             formation
        &quot;&quot;&quot;

        # 1.最低级别logging对象设置
        self.logger = logging.getLogger(filename)
        self.format_str = logging.Formatter(fmt, datefmt=&#39;%Y-%m-%d %H:%M:%S&#39;) # 设置日志格式
        self.logger.setLevel(self.level_relations.get(level))   # 设置日志级别    &lt;---

        # 2.声明不同类型的Handler对象：sh &amp; th
        sh = logging.StreamHandler()  # 控制台流式输出
        sh.setFormatter(self.format_str)   # 设置屏幕上显示的格式
        # logging.handlers.RotatingFileHandler  # 按大小切分
        # logging.FileHandler # 文件输出

        # 声明间隔时间自动生成文件的对象
        th = handlers.TimedRotatingFileHandler(filename=filename,
                                               when=when,                   # 间隔的时间单位: S/M/H/D/W/midnight
                                               backupCount=backup_count,    # 冗余备份文件数
                                               encoding=&#39;utf-8&#39;,
                                               interval=interval,           # 时间间隔
                                               delay=True                   # Flask线程问题，需开启读写时延
                                               )    # 文件写入
        th.setFormatter(self.format_str)    # 设置文件写入格式

        # 3.从对象处理器内添加
        self.logger.addHandler(sh)          # 把对象加到logger里
        self.logger.addHandler(th)
        # self.logger.removeHandler(sh)

    # def test(self):
    #     print(self.level_relations)

    def err_log_test(self):
        print(1 + &#39;_2&#39;)


current_path = f&#39;./logs/&#39;
clog = Logger(filename=current_path + f&#39;all_bokeh.log&#39;, level=&#39;info&#39;, when=&#39;D&#39;,
              fmt=&#39;%(asctime)s %(module)s.%(funcName)s -&gt; %(threadName)s -&gt; [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)

errclog = Logger(filename=current_path + f&#39;err_bokeh.log&#39;, level=&#39;error&#39;, when=&#39;D&#39;,
                 fmt=&#39;%(asctime)s %(module)s.%(funcName)s -&gt; %(threadName)s -&gt; [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)

selflog = Logger(filename=current_path + f&#39;func_log.log&#39;, level=&#39;info&#39;, when=&#39;H&#39;,
                 fmt=&#39;%(asctime)s %(module)s.%(funcName)s -&gt; %(threadName)s -&gt; [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)

errselflog = Logger(filename=current_path + f&#39;func_err.log&#39;, level=&#39;info&#39;, when=&#39;H&#39;,
                    fmt=&#39;%(asctime)s %(module)s.%(funcName)s -&gt; %(threadName)s -&gt; [line:%(lineno)d][%(levelname)s]: %(message)s&#39;)

# if __name__ == &#39;__main__&#39;:
#     from time import time, sleep
#
#     dt_start = int(time())
#     for rs in os.walk(&#39;D:\Hadoop\PyFloder\kafka_test\src&#39;):
#         print(rs)
#     print(f&#39;consume: {int(time()) - dt_start}s&#39;)
</code></pre>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/SMTP%20Python3%20PG">SMTP Python3 PG</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "20200929_1030_Python3-SMTP-CMCC&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>











</body>
</html>
